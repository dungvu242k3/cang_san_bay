<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRM C·∫£ng H√†ng Kh√¥ng - Qu·∫£n L√Ω Nh√¢n S·ª±</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #00b14f;
            --primary-dark: #009643;
            --secondary: #f37021;
            --accent: #1a73e8;
            --bg: #f5f5f5;
            --card: #fff;
            --text: #333;
            --text-light: #666;
            --border: #e0e0e0;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --radius: 8px
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh
        }

        .header {
            background: linear-gradient(135deg, #4eca7a 0%, #3cb868 100%);
            color: #fff;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow)
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px
        }

        .logo img {
            height: 60px;
            width: 60px;
            border-radius: 50%;
            background: #fff;
            padding: 5px;
            object-fit: contain;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15)
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700
        }

        .logo span {
            color: var(--secondary)
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #fff
        }

        .container {
            display: flex;
            min-height: calc(100vh - 80px)
        }

        .sidebar {
            width: 260px;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 25px;
            cursor: pointer;
            transition: all .3s;
            color: var(--text);
            border-left: 3px solid transparent
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(0, 177, 79, 0.1);
            color: var(--primary);
            border-left-color: var(--primary)
        }

        .nav-item i {
            width: 25px;
            margin-right: 12px;
            font-size: 1.1rem
        }

        .main {
            flex: 1;
            padding: 25px;
            overflow-y: auto
        }

        .page {
            display: none
        }

        .page.active {
            display: block
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px
        }

        .page-title i {
            color: var(--primary)
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: .95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all .3s
        }

        .btn-primary {
            background: var(--primary);
            color: #fff
        }

        .btn-primary:hover {
            background: var(--primary-dark)
        }

        .btn-secondary {
            background: var(--secondary);
            color: #fff
        }

        .btn-danger {
            background: var(--danger);
            color: #fff
        }

        .btn-info {
            background: var(--info);
            color: #fff
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: .85rem
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 15px
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text)
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px
        }

        .stat-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow)
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #fff
        }

        .stat-icon.green {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark))
        }

        .stat-icon.orange {
            background: linear-gradient(135deg, var(--secondary), #e5651d)
        }

        .stat-icon.blue {
            background: linear-gradient(135deg, var(--accent), #1557b0)
        }

        .stat-icon.red {
            background: linear-gradient(135deg, var(--danger), #b02a37)
        }

        .stat-info h3 {
            font-size: 1.8rem;
            color: var(--text)
        }

        .stat-info p {
            color: var(--text-light);
            font-size: .9rem
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border)
        }

        th {
            background: var(--bg);
            font-weight: 600;
            color: var(--text)
        }

        tr:hover {
            background: rgba(0, 177, 79, 0.05)
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: .8rem;
            font-weight: 500
        }

        .badge-success {
            background: #d4edda;
            color: #155724
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460
        }

        .badge-hn {
            background: #e3f2fd;
            color: #1565c0
        }

        .badge-sg {
            background: #fff3e0;
            color: #e65100
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap
        }

        .search-box input,
        .search-box select {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: .95rem
        }

        .search-box input {
            flex: 1;
            min-width: 200px
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center
        }

        .modal.show {
            display: flex
        }

        .modal-content {
            background: var(--card);
            border-radius: var(--radius);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--primary);
            color: #fff;
            border-radius: var(--radius) var(--radius) 0 0
        }

        .modal-header h3 {
            font-size: 1.3rem
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer
        }

        .modal-body {
            padding: 25px
        }

        .form-group {
            margin-bottom: 20px
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text)
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: .95rem
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            margin-top: 20px
        }

        .file-upload {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all .3s
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(0, 177, 79, 0.05)
        }

        .file-upload i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px
        }

        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px
        }

        .file-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border)
        }

        .file-item img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .file-item .remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: .7rem
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 20px
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all .3s;
            color: var(--text-light)
        }

        .tab:hover,
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary)
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width .3s
        }

        .progress-fill.green {
            background: var(--success)
        }

        .progress-fill.orange {
            background: var(--secondary)
        }

        .progress-fill.red {
            background: var(--danger)
        }

        .kpi-score {
            font-size: 1.5rem;
            font-weight: 700
        }

        .actions {
            display: flex;
            gap: 5px
        }

        .actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all .3s
        }

        .actions .edit {
            background: #e3f2fd;
            color: #1976d2
        }

        .actions .delete {
            background: #ffebee;
            color: #d32f2f
        }

        .actions .view {
            background: #e8f5e9;
            color: #388e3c
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: var(--text-light)
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--border)
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all .3s
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1
        }

        .toast.error {
            background: var(--danger)
        }

        @media(max-width:768px) {
            .sidebar {
                display: none
            }

            .container {
                flex-direction: column
            }

            .form-row {
                grid-template-columns: 1fr
            }
        }

        /* QTNS Styles */
        .dataTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px
        }

        .dataTable th,
        .dataTable td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border)
        }

        .dataTable th {
            background: var(--bg);
            font-weight: 700;
            color: var(--text);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px
        }

        .dataTable tr:hover {
            background: rgba(0, 177, 79, 0.05)
        }

        .dataTable tr.leader {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), transparent) !important
        }

        .dataTable tr.leader td {
            color: #c62828 !important;
            font-weight: 700
        }

        .groupHeader {
            background: linear-gradient(90deg, rgba(0, 177, 79, 0.15), transparent);
            padding: 12px 16px;
            font-weight: 800;
            font-size: 14px;
            color: #0b3a20;
            margin-top: 16px;
            margin-bottom: 0;
            border-radius: 8px 8px 0 0;
            border: 1px solid rgba(0, 177, 79, 0.2);
            border-bottom: none
        }

        .leaderBadge {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
            display: inline-flex;
            align-items: center;
            gap: 3px
        }

        .nameLink {
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: rgba(0, 177, 79, 0.3);
            transition: all .2s
        }

        .nameLink:hover {
            color: var(--primary-dark);
            text-decoration-color: var(--primary)
        }

        .emptyState {
            text-align: center;
            padding: 40px;
            color: var(--text-light)
        }

        .loadingState {
            text-align: center;
            padding: 40px;
            color: var(--text-light)
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace
        }

        dialog {
            border: none;
            border-radius: var(--radius);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            padding: 0;
            background: var(--card)
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px)
        }

        .modalHd {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--primary);
            color: #fff;
            border-radius: var(--radius) var(--radius) 0 0
        }

        .modalHd h3 {
            margin: 0;
            font-size: 1.2rem
        }

        .modalBd {
            padding: 24px
        }

        .field {
            margin-bottom: 16px
        }

        .field label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text);
            font-size: 13px
        }

        .field input,
        .field textarea,
        .field select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: border-color .2s
        }

        .field input:focus,
        .field textarea:focus,
        .field select:focus {
            outline: none;
            border-color: var(--primary)
        }

        .u-flex {
            display: flex
        }

        .u-gap10 {
            gap: 10px
        }

        .u-mt12 {
            margin-top: 12px
        }

        .u-justify-end {
            justify-content: flex-end
        }

        .u-items-center {
            align-items: center
        }

        .u-wrap {
            flex-wrap: wrap
        }

        /* Enhanced table styles */
        .dataTable th {
            position: sticky;
            top: 0;
            z-index: 10
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px
        }

        .status-thu-viec {
            background: #fff3cd;
            color: #856404
        }

        .status-chinh-thuc {
            background: #d4edda;
            color: #155724
        }

        .status-tam-nghi {
            background: #cce5ff;
            color: #004085
        }

        .status-nghi-viec {
            background: #f8d7da;
            color: #721c24
        }

        .priority-cao {
            background: #f8d7da;
            color: #721c24
        }

        .priority-tb {
            background: #fff3cd;
            color: #856404
        }

        .priority-thap {
            background: #d4edda;
            color: #155724
        }

        /* Payslip styles */
        .payslip-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden
        }

        .payslip-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            padding: 25px;
            text-align: center
        }

        .payslip-header h2 {
            margin: 0 0 5px;
            font-size: 1.4rem
        }

        .payslip-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem
        }

        .payslip-body {
            padding: 25px
        }

        .payslip-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee
        }

        .payslip-row:last-child {
            border-bottom: none
        }

        .payslip-row.highlight {
            background: #f8fafc;
            margin: 0 -25px;
            padding: 10px 25px;
            font-weight: 700
        }

        .payslip-row.total {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            margin: 10px -25px 0;
            padding: 15px 25px;
            font-weight: 700;
            color: #155724;
            font-size: 1.1rem
        }

        .payslip-section {
            margin-bottom: 25px
        }

        .payslip-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
            font-size: 1rem
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">
            <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
                alt="HRM C·∫£ng H√†ng Kh√¥ng Logo">
            <h1><span style="color:#1e88e5">HRM</span> <span style="color:#fff">C·∫£ng H√†ng Kh√¥ng</span></h1>
        </div>
        <div class="user-info">
            <span>Admin</span>
            <img src="https://i.pravatar.cc/40" alt="User">
        </div>
    </header>
    <div class="container">
        <nav class="sidebar">
            <div class="nav-item active" data-page="dashboard"><i class="fas fa-home"></i>T·ªïng quan</div>
            <div class="nav-item" data-page="employees"><i class="fas fa-users"></i>H·ªì s∆° nh√¢n s·ª±</div>
            <div class="nav-item" data-page="salary"><i class="fas fa-money-bill-wave"></i>B·∫≠c l∆∞∆°ng & ThƒÉng ti·∫øn</div>
            <div class="nav-item" data-page="competency"><i class="fas fa-graduation-cap"></i>NƒÉng l·ª±c nh√¢n s·ª±</div>
            <div class="nav-item" data-page="kpi"><i class="fas fa-chart-line"></i>KPI</div>
            <div class="nav-item" data-page="tasks"><i class="fas fa-tasks"></i>Giao vi·ªác</div>
            <div class="nav-item" data-page="attendance"><i class="fas fa-calendar-check"></i>Ch·∫•m c√¥ng & L∆∞∆°ng</div>
        </nav>
        <main class="main">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-home"></i>T·ªïng quan h·ªá th·ªëng</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <h3 id="total-employees">0</h3>
                            <p>T·ªïng nh√¢n vi√™n</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-city"></i></div>
                        <div class="stat-info">
                            <h3 id="total-sg">0</h3>
                            <p>üèôÔ∏è Chi nh√°nh HCM</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-building"></i></div>
                        <div class="stat-info">
                            <h3 id="total-hn">0</h3>
                            <p>üèõÔ∏è Chi nh√°nh H√† N·ªôi</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red"><i class="fas fa-tasks"></i></div>
                        <div class="stat-info">
                            <h3 id="total-tasks">0</h3>
                            <p>C√¥ng vi·ªác ƒëang th·ª±c hi·ªán</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Nh√¢n vi√™n m·ªõi nh·∫•t</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>·∫¢nh</th>
                                <th>H·ªç t√™n</th>
                                <th>V·ªã tr√≠</th>
                                <th>Chi nh√°nh</th>
                                <th>Ng√†y v√†o</th>
                            </tr>
                        </thead>
                        <tbody id="recent-employees"></tbody>
                    </table>
                </div>
            </div>
            <!-- Employees - QTNS Style -->
            <div id="employees" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-users"></i>H·ªì s∆° nh√¢n s·ª±</h2>
                    <div class="u-flex u-gap10">
                        <button class="btn btn-primary" id="btnCreateNhanVien"><i class="fas fa-plus"></i>T·∫°o m·ªõi
                            NV</button>
                        <button class="btn btn-info" onclick="openUploadExcel()"><i class="fas fa-file-excel"></i>Import
                            Excel</button>
                        <button class="btn btn-secondary" id="btnRefreshNhanSu"><i class="fas fa-sync"></i>L√†m
                            m·ªõi</button>
                    </div>
                </div>
                <!-- Tabs for different sections -->
                <div class="tabs" style="margin-bottom:20px;">
                    <div class="tab active" onclick="showEmployeeTab('list')">üìã Danh s√°ch NV</div>
                    <div class="tab" onclick="showEmployeeTab('recruitment')">üìù Tuy·ªÉn d·ª•ng</div>
                    <div class="tab" onclick="showEmployeeTab('status-history')">üìä Bi·∫øn ƒë·ªông NS</div>
                </div>
                <!-- Employee List Tab -->
                <div id="employee-list-tab">
                    <div class="search-box">
                        <input type="text" id="search-employee" placeholder="T√¨m theo M√£ NV, H·ªç t√™n, SƒêT, Email..."
                            oninput="filterNhanSu()">
                        <select id="filter-branch" onchange="filterNhanSu()">
                            <option value="">T·∫•t c·∫£ chi nh√°nh</option>
                            <option value="HCM">HCM</option>
                            <option value="H√† N·ªôi">H√† N·ªôi</option>
                        </select>
                        <select id="filter-dept" onchange="filterNhanSu()">
                            <option value="">T·∫•t c·∫£ ph√≤ng ban</option>
                        </select>
                        <select id="filter-status" onchange="filterNhanSu()">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="Th·ª≠ vi·ªác">Th·ª≠ vi·ªác</option>
                            <option value="Ch√≠nh th·ª©c">Ch√≠nh th·ª©c</option>
                            <option value="T·∫°m ngh·ªâ">T·∫°m ngh·ªâ</option>
                            <option value="Ngh·ªâ vi·ªác">Ngh·ªâ vi·ªác</option>
                        </select>
                    </div>
                    <div class="card" id="nhanSuTableContainer">
                        <div class="loadingState">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                    </div>
                </div>
                <!-- Recruitment Tab -->
                <div id="employee-recruitment-tab" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-sitemap"
                                    style="color:var(--primary);margin-right:8px;"></i>B·∫£ng ƒë·ªãnh bi√™n nh√¢n s·ª±</h3>
                            <button class="btn btn-primary btn-sm" onclick="openDinhBienModal()"><i
                                    class="fas fa-plus"></i>Th√™m ƒë·ªãnh bi√™n</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>Hi·ªán c√≥</th>
                                    <th>ƒê·ªãnh bi√™n</th>
                                    <th>C·∫ßn tuy·ªÉn</th>
                                    <th>Ghi ch√∫</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="dinh-bien-list"></tbody>
                        </table>
                    </div>
                    <div class="card" style="margin-top:20px;">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-file-alt"
                                    style="color:var(--secondary);margin-right:8px;"></i>Qu·∫£n l√Ω CV ·ª©ng vi√™n</h3>
                            <button class="btn btn-primary btn-sm" onclick="openCVModal()"><i
                                    class="fas fa-plus"></i>Th√™m CV</button>
                        </div>
                        <div class="search-box" style="margin-bottom:15px;">
                            <select id="filter-cv-status" onchange="filterCV()">
                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                <option value="CV ti·∫øp nh·∫≠n">CV ti·∫øp nh·∫≠n</option>
                                <option value="CV ƒë√£ li√™n h·ªá">CV ƒë√£ li√™n h·ªá</option>
                                <option value="CV ph·ªèng v·∫•n">CV ph·ªèng v·∫•n</option>
                                <option value="CV tr√∫ng tuy·ªÉn">CV tr√∫ng tuy·ªÉn</option>
                                <option value="CV kh√¥ng ph√π h·ª£p">CV kh√¥ng ph√π h·ª£p</option>
                            </select>
                            <select id="filter-cv-position" onchange="filterCV()">
                                <option value="">T·∫•t c·∫£ v·ªã tr√≠</option>
                            </select>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>SƒêT</th>
                                    <th>Email</th>
                                    <th>V·ªã tr√≠ ·ª©ng tuy·ªÉn</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>Ngu·ªìn CV</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Ng√†y ti·∫øp nh·∫≠n</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="cv-list"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Status History Tab -->
                <div id="employee-status-history-tab" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-history"
                                    style="color:var(--accent);margin-right:8px;"></i>Bi·∫øn ƒë·ªông nh√¢n s·ª± trong k·ª≥</h3>
                            <div class="u-flex u-gap10">
                                <input type="date" id="status-from-date"
                                    style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <input type="date" id="status-to-date"
                                    style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <button class="btn btn-info btn-sm" onclick="filterStatusHistory()"><i
                                        class="fas fa-search"></i>Xem</button>
                            </div>
                        </div>
                        <div class="stats-grid" style="margin-bottom:20px;">
                            <div class="stat-card">
                                <div class="stat-icon green"><i class="fas fa-user-plus"></i></div>
                                <div class="stat-info">
                                    <h3 id="stat-thu-viec">0</h3>
                                    <p>Th·ª≠ vi·ªác m·ªõi</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon blue"><i class="fas fa-user-check"></i></div>
                                <div class="stat-info">
                                    <h3 id="stat-chinh-thuc">0</h3>
                                    <p>K√Ω Hƒê ch√≠nh th·ª©c</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon red"><i class="fas fa-user-minus"></i></div>
                                <div class="stat-info">
                                    <h3 id="stat-nghi-viec">0</h3>
                                    <p>Ngh·ªâ vi·ªác</p>
                                </div>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>T√™n nh√¢n vi√™n</th>
                                    <th>Tr·∫°ng th√°i c≈©</th>
                                    <th>Tr·∫°ng th√°i m·ªõi</th>
                                    <th>Ng√†y hi·ªáu l·ª±c</th>
                                    <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                                    <th>Ghi ch√∫</th>
                                </tr>
                            </thead>
                            <tbody id="status-history-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Salary -->
            <div id="salary" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-money-bill-wave"></i>Qu·∫£n tr·ªã b·∫≠c l∆∞∆°ng & ThƒÉng ti·∫øn</h2>
                    <button class="btn btn-primary" onclick="openModal('salaryModal')"><i class="fas fa-plus"></i>Th√™m
                        b·∫≠c l∆∞∆°ng</button>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="showSalaryTab('grades')">üìä Danh m·ª•c b·∫≠c l∆∞∆°ng</div>
                    <div class="tab" onclick="showSalaryTab('employee-salary')">üë§ B·∫≠c l∆∞∆°ng NV</div>
                    <div class="tab" onclick="showSalaryTab('promotions')">üìà L·ªãch s·ª≠ thƒÉng ti·∫øn</div>
                </div>
                <!-- B·∫£ng 1: Danh m·ª•c v·ªã tr√≠ & b·∫≠c l∆∞∆°ng -->
                <div id="grades-tab" class="card">
                    <div class="card-header">
                        <h3 class="card-title">B·∫£ng danh m·ª•c v·ªã tr√≠ & b·∫≠c l∆∞∆°ng</h3>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>Ca l√†m vi·ªác</th>
                                    <th>Doanh thu t·ª´ (tri·ªáu)</th>
                                    <th>Doanh thu ƒë·∫øn (tri·ªáu)</th>
                                    <th>B·∫≠c l∆∞∆°ng</th>
                                    <th>L∆∞∆°ng P1 (VNƒê)</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="salary-grades"></tbody>
                        </table>
                    </div>
                </div>
                <!-- B·∫£ng 2: B·∫≠c l∆∞∆°ng nh√¢n vi√™n -->
                <div id="employee-salary-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">Qu·∫£n l√Ω b·∫≠c l∆∞∆°ng nh√¢n vi√™n</h3>
                        <button class="btn btn-primary btn-sm" onclick="openEmployeeSalaryModal()"><i
                                class="fas fa-plus"></i>G√°n b·∫≠c l∆∞∆°ng NV</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>Ca l√†m vi·ªác</th>
                                    <th>B·∫≠c l∆∞∆°ng P1</th>
                                    <th>L∆∞∆°ng P1 (VNƒê)</th>
                                    <th>Ng√†y hi·ªáu l·ª±c</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="employee-salary-list"></tbody>
                        </table>
                    </div>
                </div>
                <!-- B·∫£ng 3: L·ªãch s·ª≠ thƒÉng ti·∫øn -->
                <div id="promotions-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">L·ªãch s·ª≠ thay ƒë·ªïi b·∫≠c l∆∞∆°ng</h3>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>Ca</th>
                                    <th>B·∫≠c l∆∞∆°ng</th>
                                    <th>L∆∞∆°ng P1</th>
                                    <th>Ng√†y thay ƒë·ªïi</th>
                                    <th>H√¨nh th·ª©c</th>
                                    <th>L√Ω do</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="promotion-history"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Competency -->
            <div id="competency" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-graduation-cap"></i>Qu·∫£n tr·ªã nƒÉng l·ª±c nh√¢n s·ª±</h2>
                    <button class="btn btn-primary" onclick="openModal('competencyFrameworkModal')"><i
                            class="fas fa-plus"></i>Th√™m nƒÉng l·ª±c</button>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="showCompTab('framework')">üìã Khung nƒÉng l·ª±c</div>
                    <div class="tab" onclick="showCompTab('evaluation')">‚≠ê ƒê√°nh gi√° nƒÉng l·ª±c</div>
                    <div class="tab" onclick="showCompTab('training')">üìö ƒê√†o t·∫°o n·ªôi b·ªô</div>
                </div>
                <!-- Khung nƒÉng l·ª±c theo v·ªã tr√≠ -->
                <div id="framework-tab" class="card">
                    <div class="card-header">
                        <h3 class="card-title">Khung nƒÉng l·ª±c theo v·ªã tr√≠</h3>
                        <div class="u-flex u-gap10">
                            <select id="filter-framework-dept" onchange="filterCompetencyFramework()"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="">Ch·ªçn b·ªô ph·∫≠n</option>
                            </select>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Nh√≥m nƒÉng l·ª±c</th>
                                    <th>T√™n nƒÉng l·ª±c</th>
                                    <th>Level 1</th>
                                    <th>Level 2</th>
                                    <th>Level 3</th>
                                    <th>Level 4</th>
                                    <th>Level 5</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="competency-framework-list"></tbody>
                        </table>
                    </div>
                </div>
                <!-- ƒê√°nh gi√° nƒÉng l·ª±c ƒë·ªãnh k·ª≥ -->
                <div id="evaluation-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">K·∫øt qu·∫£ ƒë√°nh gi√° nƒÉng l·ª±c theo k·ª≥</h3>
                        <div class="u-flex u-gap10">
                            <select id="filter-eval-dept"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="">Ch·ªçn b·ªô ph·∫≠n</option>
                            </select>
                            <select id="filter-eval-period"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="">Ch·ªçn k·ª≥ ƒë√°nh gi√°</option>
                                <option value="Q1/2025">Q1/2025</option>
                                <option value="Q2/2025">Q2/2025</option>
                                <option value="Q3/2025">Q3/2025</option>
                                <option value="Q4/2025">Q4/2025</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="openModal('evalModal')"><i
                                    class="fas fa-plus"></i>Nh·∫≠p ƒë√°nh gi√°</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>K·ª≥</th>
                                <th>M√£ NV</th>
                                <th>H·ªç v√† t√™n</th>
                                <th>B·ªô ph·∫≠n</th>
                                <th>V·ªã tr√≠</th>
                                <th>ƒêi·ªÉm YC</th>
                                <th>ƒêi·ªÉm KQ</th>
                                <th>K·∫øt qu·∫£</th>
                                <th>Ng√†y ƒêG</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="evaluation-list"></tbody>
                    </table>
                </div>
                <!-- ƒê√†o t·∫°o n·ªôi b·ªô -->
                <div id="training-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">Danh s√°ch ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('trainingModal')"><i
                                class="fas fa-plus"></i>Th√™m CTƒêT</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>M√£ CT</th>
                                <th>T√™n ch∆∞∆°ng tr√¨nh</th>
                                <th>H√¨nh th·ª©c</th>
                                <th>ƒê∆°n v·ªã ƒêT</th>
                                <th>Th·ªùi gian</th>
                                <th>M·ª•c ti√™u</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="training-list"></tbody>
                    </table>
                    <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px;">
                        <h4 style="margin-bottom:15px;color:var(--text);">Danh s√°ch h·ªçc vi√™n & K·∫øt qu·∫£ ƒë√†o t·∫°o</h4>
                        <div class="u-flex u-gap10" style="margin-bottom:15px;">
                            <select id="filter-training-program" onchange="filterTrainingParticipants()"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);flex:1;">
                                <option value="">Ch·ªçn ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" onclick="openTrainingParticipantModal()"><i
                                    class="fas fa-user-plus"></i>G√°n h·ªçc vi√™n</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>T√¨nh tr·∫°ng</th>
                                    <th>T·ª∑ l·ªá tham d·ª±</th>
                                    <th>ƒêi·ªÉm thu ho·∫°ch</th>
                                    <th>X·∫øp lo·∫°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="training-participants-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- KPI -->
            <div id="kpi" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-chart-line"></i>Giao & ƒê√°nh gi√° KPI</h2>
                    <button class="btn btn-primary" onclick="openModal('kpiCatalogModal')"><i
                            class="fas fa-plus"></i>Th√™m danh m·ª•c KPI</button>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="showKPITab('catalog')">üìã Danh m·ª•c KPI</div>
                    <div class="tab" onclick="showKPITab('assign')">üë§ Giao KPI c√° nh√¢n</div>
                    <div class="tab" onclick="showKPITab('conversion')">üîÑ T·ª∑ l·ªá quy ƒë·ªïi</div>
                    <div class="tab" onclick="showKPITab('results')">üìä K·∫øt qu·∫£ KPI</div>
                </div>
                <!-- B·∫£ng 1: Danh m·ª•c KPI -->
                <div id="kpi-catalog-tab" class="card">
                    <div class="card-header">
                        <h3 class="card-title">Qu·∫£n l√Ω danh m·ª•c KPI</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>M√£ KPI</th>
                                <th>T√™n KPI</th>
                                <th>ƒê∆°n v·ªã ƒëo</th>
                                <th>ƒê·ªëi t∆∞·ª£ng √°p d·ª•ng</th>
                                <th>Tr·ªçng s·ªë (%)</th>
                                <th>Th√°ng √°p d·ª•ng</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="kpi-catalog-list"></tbody>
                    </table>
                </div>
                <!-- B·∫£ng 2: Giao KPI c√° nh√¢n -->
                <div id="kpi-assign-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">Nh·∫≠p KPI cho t·ª´ng c√° nh√¢n</h3>
                        <button class="btn btn-primary btn-sm" onclick="openModal('kpiModal')"><i
                                class="fas fa-plus"></i>Giao KPI</button>
                    </div>
                    <div class="search-box" style="margin-bottom:15px;">
                        <select id="filter-kpi-dept"
                            style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                            <option value="">T·∫•t c·∫£ b·ªô ph·∫≠n</option>
                        </select>
                        <select id="filter-kpi-month"
                            style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                            <option value="">Ch·ªçn th√°ng</option>
                            <option value="01">Th√°ng 1</option>
                            <option value="02">Th√°ng 2</option>
                            <option value="03">Th√°ng 3</option>
                            <option value="04">Th√°ng 4</option>
                            <option value="05">Th√°ng 5</option>
                            <option value="06">Th√°ng 6</option>
                            <option value="07">Th√°ng 7</option>
                            <option value="08">Th√°ng 8</option>
                            <option value="09">Th√°ng 9</option>
                            <option value="10">Th√°ng 10</option>
                            <option value="11">Th√°ng 11</option>
                            <option value="12">Th√°ng 12</option>
                        </select>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>Ca</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>KPI-1</th>
                                    <th>KPI-2</th>
                                    <th>KPI-3</th>
                                    <th>T·ªïng tr·ªçng s·ªë</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="kpi-assign-list"></tbody>
                        </table>
                    </div>
                </div>
                <!-- B·∫£ng 3: T·ª∑ l·ªá quy ƒë·ªïi KPI -->
                <div id="kpi-conversion-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">Khai b√°o t·ª∑ l·ªá quy ƒë·ªïi cho t·ª´ng m√£ KPI</h3>
                        <div class="u-flex u-gap10">
                            <select id="select-kpi-code"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="">Ch·ªçn m√£ KPI</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="openKPIConversionModal()"><i
                                    class="fas fa-plus"></i>Th√™m t·ª∑ l·ªá</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>T·ª∑ l·ªá ho√†n th√†nh t·ª´</th>
                                <th>T·ª∑ l·ªá ho√†n th√†nh ƒë·∫øn</th>
                                <th>% Quy ƒë·ªïi KPI</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="kpi-conversion-list"></tbody>
                    </table>
                </div>
                <!-- B·∫£ng 4: K·∫øt qu·∫£ KPI -->
                <div id="kpi-results-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">K·∫øt qu·∫£ ho√†n th√†nh v√† quy ƒë·ªïi KPI</h3>
                        <div class="u-flex u-gap10">
                            <select id="filter-result-dept"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="">T·∫•t c·∫£ b·ªô ph·∫≠n</option>
                            </select>
                            <select id="filter-result-month"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="">Ch·ªçn th√°ng</option>
                            </select>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>Ca</th>
                                    <th>Th√°ng</th>
                                    <th>KPI-1 (TT)</th>
                                    <th>KPI-2 (TT)</th>
                                    <th>KPI-3 (TT)</th>
                                    <th>% Qƒê KPI-1</th>
                                    <th>% Qƒê KPI-2</th>
                                    <th>% Qƒê KPI-3</th>
                                    <th>KPI t·ªïng</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="kpi-results-list"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border);">
                        <h4 style="margin-bottom:15px;">B√°o c√°o t·ªïng h·ª£p theo b·ªô ph·∫≠n</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>S·ªë nh√¢n s·ª±</th>
                                    <th>% ƒê·∫°t KPI</th>
                                    <th>% V∆∞·ª£t KPI</th>
                                    <th>% Kh√¥ng ƒë·∫°t</th>
                                    <th>ƒêi·ªÉm KPI TB</th>
                                    <th>Ghi ch√∫</th>
                                </tr>
                            </thead>
                            <tbody id="kpi-dept-summary"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Tasks -->
            <div id="tasks" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-tasks"></i>Qu·∫£n tr·ªã giao vi·ªác</h2>
                    <button class="btn btn-primary" onclick="openModal('taskModal')"><i class="fas fa-plus"></i>T·∫°o Task
                        m·ªõi</button>
                </div>
                <div class="search-box">
                    <input type="text" placeholder="T√¨m c√¥ng vi·ªác..." id="search-task" oninput="filterTasks()">
                    <select id="filter-task-dept" onchange="filterTasks()"
                        style="padding:10px;border:1px solid var(--border);border-radius:var(--radius);">
                        <option value="">T·∫•t c·∫£ b·ªô ph·∫≠n</option>
                    </select>
                    <select id="filter-task-priority" onchange="filterTasks()"
                        style="padding:10px;border:1px solid var(--border);border-radius:var(--radius);">
                        <option value="">T·∫•t c·∫£ m·ª©c ∆∞u ti√™n</option>
                        <option value="Cao">Cao</option>
                        <option value="Trung b√¨nh">Trung b√¨nh</option>
                        <option value="Th·∫•p">Th·∫•p</option>
                    </select>
                    <select id="filter-task-status" onchange="filterTasks()">
                        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="ƒêang l√†m">ƒêang l√†m</option>
                        <option value="ƒê√£ xong">ƒê√£ xong</option>
                        <option value="Qu√° h·∫°n">Qu√° h·∫°n</option>
                    </select>
                </div>
                <div class="card">
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ CV</th>
                                    <th>T√™n c√¥ng vi·ªác</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>Ng∆∞·ªùi giao</th>
                                    <th>Ng∆∞·ªùi nh·∫≠n</th>
                                    <th>M·ª©c ∆∞u ti√™n</th>
                                    <th>Ng√†y Bƒê</th>
                                    <th>Deadline</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Link KQ</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="task-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Attendance & Payroll -->
            <div id="attendance" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-calendar-check"></i>Ch·∫•m c√¥ng - T√≠nh l∆∞∆°ng - BHXH - Thu·∫ø
                    </h2>
                    <button class="btn btn-primary" onclick="openModal('attendanceModal')"><i
                            class="fas fa-file-import"></i>Import ch·∫•m c√¥ng</button>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="showAttTab('timekeeping')">üìÖ Ch·∫•m c√¥ng</div>
                    <div class="tab" onclick="showAttTab('payroll')">üí∞ B·∫£ng l∆∞∆°ng 3P</div>
                    <div class="tab" onclick="showAttTab('bhxh')">üè• BHXH</div>
                    <div class="tab" onclick="showAttTab('tax')">üíµ Thu·∫ø TNCN</div>
                    <div class="tab" onclick="showAttTab('payslip')">üìÑ Phi·∫øu l∆∞∆°ng</div>
                </div>
                <!-- Ch·∫•m c√¥ng -->
                <div id="timekeeping-tab" class="card">
                    <div class="card-header">
                        <h3 class="card-title">B·∫£ng ch·∫•m c√¥ng n·ªôi b·ªô</h3>
                        <div class="u-flex u-gap10">
                            <select id="att-month"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="1">Th√°ng 1</option>
                                <option value="2">Th√°ng 2</option>
                                <option value="3">Th√°ng 3</option>
                                <option value="4">Th√°ng 4</option>
                                <option value="5">Th√°ng 5</option>
                                <option value="6">Th√°ng 6</option>
                                <option value="7">Th√°ng 7</option>
                                <option value="8">Th√°ng 8</option>
                                <option value="9">Th√°ng 9</option>
                                <option value="10">Th√°ng 10</option>
                                <option value="11">Th√°ng 11</option>
                                <option value="12" selected>Th√°ng 12</option>
                            </select>
                            <select id="att-year"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                            </select>
                            <button class="btn btn-info btn-sm" onclick="loadAttendance()"><i
                                    class="fas fa-search"></i>Xem</button>
                            <button class="btn btn-primary btn-sm" onclick="openModal('attendanceModal')"><i
                                    class="fas fa-plus"></i>Th√™m CC</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>H·ªç t√™n</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>C√¥ng chu·∫©n</th>
                                    <th>C√¥ng TT</th>
                                    <th>ƒêi mu·ªôn</th>
                                    <th>V·ªÅ s·ªõm</th>
                                    <th>Ngh·ªâ ph√©p</th>
                                    <th>Ngh·ªâ KP</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-list"></tbody>
                        </table>
                    </div>
                </div>
                <!-- B·∫£ng l∆∞∆°ng 3P -->
                <div id="payroll-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">B·∫£ng l∆∞∆°ng t·ªïng h·ª£p (C√¥ng + L∆∞∆°ng 3P + Th∆∞·ªüng n√≥ng)</h3>
                        <div class="u-flex u-gap10">
                            <select id="payroll-month"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="12" selected>Th√°ng 12/2025</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" onclick="calculatePayroll()"><i
                                    class="fas fa-calculator"></i>T√≠nh l∆∞∆°ng</button>
                            <button class="btn btn-info btn-sm" onclick="exportPayroll()"><i
                                    class="fas fa-file-excel"></i>Xu·∫•t Excel</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>H·ªç t√™n</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>V·ªã tr√≠</th>
                                    <th>C√¥ng TT</th>
                                    <th>L∆∞∆°ng P1</th>
                                    <th>KQ P3 (%)</th>
                                    <th>L∆∞∆°ng 3P</th>
                                    <th>L∆∞∆°ng ng√†y c√¥ng</th>
                                    <th>Th∆∞·ªüng n√≥ng</th>
                                    <th>T·ªïng TN</th>
                                    <th>Kh·∫•u tr·ª´</th>
                                    <th>Th·ª±c lƒ©nh</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="payroll-list"></tbody>
                        </table>
                    </div>
                </div>
                <!-- BHXH -->
                <div id="bhxh-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">Th√¥ng tin BHXH</h3>
                        <button class="btn btn-primary btn-sm" onclick="openBHXHModal()"><i class="fas fa-plus"></i>Th√™m
                            BHXH</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>H·ªç t√™n</th>
                                    <th>B·ªô ph·∫≠n</th>
                                    <th>S·ªë s·ªï BHXH</th>
                                    <th>Ng√†y tham gia</th>
                                    <th>M·ª©c l∆∞∆°ng ƒë√≥ng</th>
                                    <th>T·ª∑ l·ªá NLƒê (%)</th>
                                    <th>T·ª∑ l·ªá DN (%)</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="bhxh-list"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Thu·∫ø TNCN -->
                <div id="tax-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">Th√¥ng tin Thu·∫ø TNCN</h3>
                        <button class="btn btn-primary btn-sm" onclick="openTaxModal()"><i class="fas fa-plus"></i>Th√™m
                            th√¥ng tin thu·∫ø</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>H·ªç t√™n</th>
                                    <th>MST TNCN</th>
                                    <th>TN t√≠nh thu·∫ø</th>
                                    <th>Gi·∫£m tr·ª´ BT</th>
                                    <th>Gi·∫£m tr·ª´ NPT</th>
                                    <th>TN ch·ªãu thu·∫ø</th>
                                    <th>Bi·ªÉu thu·∫ø</th>
                                    <th>Thu·∫ø ph·∫£i n·ªôp</th>
                                    <th>K·ª≥</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="tax-list"></tbody>
                        </table>
                    </div>
                    <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border);">
                        <h4 style="margin-bottom:15px;">Qu·∫£n l√Ω ng∆∞·ªùi ph·ª• thu·ªôc</h4>
                        <button class="btn btn-secondary btn-sm" onclick="openDependentModal()"
                            style="margin-bottom:15px;"><i class="fas fa-plus"></i>Th√™m NPT</button>
                        <table>
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ NV</th>
                                    <th>H·ªç t√™n NV</th>
                                    <th>H·ªç t√™n NPT</th>
                                    <th>Quan h·ªá</th>
                                    <th>Ng√†y sinh</th>
                                    <th>CCCD</th>
                                    <th>Gi·∫£m tr·ª´ t·ª´</th>
                                    <th>Gi·∫£m tr·ª´ ƒë·∫øn</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="dependent-list"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Phi·∫øu l∆∞∆°ng -->
                <div id="payslip-tab" class="card" style="display:none">
                    <div class="card-header">
                        <h3 class="card-title">Phi·∫øu l∆∞∆°ng c√° nh√¢n</h3>
                        <div class="u-flex u-gap10">
                            <select id="payslip-employee"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);flex:1;">
                                <option value="">Ch·ªçn nh√¢n vi√™n</option>
                            </select>
                            <select id="payslip-month"
                                style="padding:8px;border:1px solid var(--border);border-radius:var(--radius);">
                                <option value="12/2025">Th√°ng 12/2025</option>
                            </select>
                            <button class="btn btn-info btn-sm" onclick="viewPayslip()"><i
                                    class="fas fa-eye"></i>Xem</button>
                            <button class="btn btn-secondary btn-sm" onclick="printPayslip()"><i
                                    class="fas fa-print"></i>In</button>
                        </div>
                    </div>
                    <div id="payslip-content"
                        style="background:#f8fafc;border-radius:var(--radius);padding:30px;margin-top:20px;display:none;">
                        <!-- Payslip content will be rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Nh√¢n vi√™n Detail Modal -->
    <dialog id="nhanVienDetailModal">
        <div class="modalHd">
            <h3 id="detailModalTitle">Th√¥ng tin nh√¢n vi√™n</h3>
            <button class="btn" id="btnCloseDetail" style="background:#fff;color:#333;padding:8px 16px;">ƒê√≥ng</button>
        </div>
        <div class="modalBd" style="max-height:80vh;overflow-y:auto;">
            <div id="detailContent"></div>
        </div>
    </dialog>

    <!-- Edit Nh√¢n vi√™n Modal -->
    <dialog id="editNhanVienModal">
        <div class="modalHd">
            <h3 id="editModalTitle">Ch·ªânh s·ª≠a th√¥ng tin nh√¢n vi√™n</h3>
            <button class="btn" id="btnCloseEdit" style="background:#fff;color:#333;padding:8px 16px;">ƒê√≥ng</button>
        </div>
        <div class="modalBd" style="max-height:80vh;overflow-y:auto;">
            <div id="editContent"></div>
        </div>
    </dialog>

    <!-- Create Nh√¢n vi√™n Modal -->
    <dialog id="createNhanVienModal">
        <div class="modalHd">
            <h3>T·∫°o nh√¢n vi√™n m·ªõi</h3>
            <button class="btn" id="btnCloseCreate" style="background:#fff;color:#333;padding:8px 16px;">ƒê√≥ng</button>
        </div>
        <div class="modalBd" style="max-height:80vh;overflow-y:auto;">
            <div id="createContent"></div>
        </div>
    </dialog>

    <!-- Salary Grade Modal -->
    <div id="salaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-dollar-sign"></i> Th√™m/S·ª≠a b·∫≠c l∆∞∆°ng</h3><button class="modal-close"
                    onclick="closeModal('salaryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="salaryForm">
                    <input type="hidden" id="grade-id">
                    <div class="form-row">
                        <div class="form-group"><label>V·ªã tr√≠ *</label><input type="text" id="grade-name" required
                                placeholder="VD: Sale 1, MKT 2"></div>
                        <div class="form-group"><label>Ca l√†m vi·ªác</label><select id="grade-shift">
                                <option value="Ca ng√†y">Ca ng√†y</option>
                                <option value="Ca ƒë√™m">Ca ƒë√™m</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Doanh thu t·ª´ (tri·ªáu)</label><input type="number"
                                id="grade-revenue-from" value="0" min="0"></div>
                        <div class="form-group"><label>Doanh thu ƒë·∫øn (tri·ªáu)</label><input type="text"
                                id="grade-revenue-to" placeholder="Kh√¥ng gi·ªõi h·∫°n"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>B·∫≠c l∆∞∆°ng *</label><input type="number" id="grade-level" required
                                min="1" placeholder="1-10"></div>
                        <div class="form-group"><label>L∆∞∆°ng P1 (VNƒê) *</label><input type="number" id="grade-salary"
                                required placeholder="9000000"></div>
                    </div>
                    <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="grade-status">
                            <option value="ƒêang √°p d·ª•ng">ƒêang √°p d·ª•ng</option>
                            <option value="Ng·ª´ng √°p d·ª•ng">Ng·ª´ng √°p d·ª•ng</option>
                        </select></div>
                    <div class="form-group"><label>M√¥ t·∫£</label><textarea id="grade-desc"></textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('salaryModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Training Modal -->
    <div id="trainingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chalkboard-teacher"></i> Th√™m kh√≥a ƒë√†o t·∫°o</h3><button class="modal-close"
                    onclick="closeModal('trainingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="trainingForm">
                    <input type="hidden" id="training-id">
                    <div class="form-group"><label>T√™n kh√≥a ƒë√†o t·∫°o *</label><input type="text" id="training-name"
                            required></div>
                    <div class="form-row">
                        <div class="form-group"><label>Gi·∫£ng vi√™n *</label><input type="text" id="training-instructor"
                                required></div>
                        <div class="form-group"><label>S·ªë h·ªçc vi√™n</label><input type="number" id="training-students"
                                value="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" id="training-start"></div>
                        <div class="form-group"><label>Ng√†y k·∫øt th√∫c</label><input type="date" id="training-end"></div>
                    </div>
                    <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="training-status">
                            <option value="S·∫Øp di·ªÖn ra">S·∫Øp di·ªÖn ra</option>
                            <option value="ƒêang di·ªÖn ra">ƒêang di·ªÖn ra</option>
                            <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                        </select></div>
                    <div class="form-group"><label>M√¥ t·∫£</label><textarea id="training-desc"></textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('trainingModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Evaluation Modal -->
    <div id="evalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-star"></i> ƒê√°nh gi√° nƒÉng l·ª±c</h3><button class="modal-close"
                    onclick="closeModal('evalModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="evalForm">
                    <input type="hidden" id="eval-id">
                    <div class="form-group"><label>Nh√¢n vi√™n *</label><select id="eval-employee" required></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>K·ªπ nƒÉng chuy√™n m√¥n (1-10) *</label><input type="number"
                                id="eval-technical" required min="1" max="10"></div>
                        <div class="form-group"><label>K·ªπ nƒÉng m·ªÅm (1-10) *</label><input type="number" id="eval-soft"
                                required min="1" max="10"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Th√°i ƒë·ªô l√†m vi·ªác (1-10) *</label><input type="number"
                                id="eval-attitude" required min="1" max="10"></div>
                        <div class="form-group"><label>Ng√†y ƒë√°nh gi√°</label><input type="date" id="eval-date"></div>
                    </div>
                    <div class="form-group"><label>Nh·∫≠n x√©t</label><textarea id="eval-comment"></textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('evalModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- KPI Modal -->
    <div id="kpiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bullseye"></i> Giao KPI</h3><button class="modal-close"
                    onclick="closeModal('kpiModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="kpiForm">
                    <input type="hidden" id="kpi-id">
                    <div class="form-group"><label>Nh√¢n vi√™n *</label><select id="kpi-employee" required></select></div>
                    <div class="form-group"><label>Ch·ªâ ti√™u KPI *</label><input type="text" id="kpi-name" required
                            placeholder="VD: Doanh s·ªë b√°n h√†ng"></div>
                    <div class="form-row">
                        <div class="form-group"><label>M·ª•c ti√™u *</label><input type="text" id="kpi-target" required
                                placeholder="VD: 100 tri·ªáu"></div>
                        <div class="form-group"><label>K·∫øt qu·∫£ hi·ªán t·∫°i</label><input type="text" id="kpi-result"
                                placeholder="VD: 75 tri·ªáu"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ti·∫øn ƒë·ªô (%)</label><input type="number" id="kpi-progress"
                                value="0" min="0" max="100"></div>
                        <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="kpi-status">
                                <option value="ƒêang th·ª±c hi·ªán">ƒêang th·ª±c hi·ªán</option>
                                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                                <option value="Ch∆∞a ƒë·∫°t">Ch∆∞a ƒë·∫°t</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" id="kpi-start"></div>
                        <div class="form-group"><label>Ng√†y k·∫øt th√∫c</label><input type="date" id="kpi-end"></div>
                    </div>
                    <div class="form-group"><label>Ghi ch√∫</label><textarea id="kpi-note"></textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('kpiModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clipboard-list"></i> Giao vi·ªác</h3><button class="modal-close"
                    onclick="closeModal('taskModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="task-id">
                    <div class="form-group"><label>T√™n c√¥ng vi·ªác *</label><input type="text" id="task-name" required>
                    </div>
                    <div class="form-group"><label>Ng∆∞·ªùi th·ª±c hi·ªán *</label><select id="task-assignee"
                            required></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>ƒê·ªô ∆∞u ti√™n</label><select id="task-priority">
                                <option value="Th·∫•p">Th·∫•p</option>
                                <option value="Trung b√¨nh" selected>Trung b√¨nh</option>
                                <option value="Cao">Cao</option>
                                <option value="Kh·∫©n c·∫•p">Kh·∫©n c·∫•p</option>
                            </select></div>
                        <div class="form-group"><label>Deadline</label><input type="date" id="task-deadline"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ti·∫øn ƒë·ªô (%)</label><input type="number" id="task-progress"
                                value="0" min="0" max="100"></div>
                        <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="task-status">
                                <option value="M·ªõi">M·ªõi</option>
                                <option value="ƒêang l√†m">ƒêang l√†m</option>
                                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                                <option value="Tr·ªÖ h·∫°n">Tr·ªÖ h·∫°n</option>
                            </select></div>
                    </div>
                    <div class="form-group"><label>M√¥ t·∫£ c√¥ng vi·ªác</label><textarea id="task-desc"></textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('taskModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-clock"></i> Ch·∫•m c√¥ng</h3><button class="modal-close"
                    onclick="closeModal('attendanceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="attendanceForm">
                    <input type="hidden" id="att-id">
                    <div class="form-group"><label>Nh√¢n vi√™n *</label><select id="att-employee" required></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>Th√°ng</label><input type="number" id="att-m" min="1" max="12"
                                value="12"></div>
                        <div class="form-group"><label>NƒÉm</label><input type="number" id="att-y" value="2025"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ng√†y c√¥ng</label><input type="number" id="att-workdays"
                                value="22" min="0" max="31"></div>
                        <div class="form-group"><label>ƒêi mu·ªôn (l·∫ßn)</label><input type="number" id="att-late" value="0"
                                min="0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>V·ªÅ s·ªõm (l·∫ßn)</label><input type="number" id="att-early" value="0"
                                min="0"></div>
                        <div class="form-group"><label>Ngh·ªâ ph√©p (ng√†y)</label><input type="number" id="att-leave"
                                value="0" min="0"></div>
                    </div>
                    <div class="form-group"><label>Ngh·ªâ kh√¥ng ph√©p (ng√†y)</label><input type="number" id="att-absent"
                            value="0" min="0"></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('attendanceModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ƒê·ªãnh bi√™n Modal -->
    <div id="dinhBienModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-sitemap"></i> ƒê·ªãnh bi√™n nh√¢n s·ª±</h3><button class="modal-close"
                    onclick="closeModal('dinhBienModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="dinhBienForm">
                    <input type="hidden" id="dinh-bien-id">
                    <div class="form-row">
                        <div class="form-group"><label>B·ªô ph·∫≠n *</label><select id="dinh-bien-dept" required>
                                <option value="">Ch·ªçn b·ªô ph·∫≠n</option>
                            </select></div>
                        <div class="form-group"><label>V·ªã tr√≠ *</label><input type="text" id="dinh-bien-position"
                                required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Nh√¢n s·ª± hi·ªán c√≥</label><input type="number"
                                id="dinh-bien-current" value="0" min="0"></div>
                        <div class="form-group"><label>ƒê·ªãnh bi√™n *</label><input type="number" id="dinh-bien-target"
                                required min="0"></div>
                    </div>
                    <div class="form-group"><label>Ghi ch√∫</label><textarea id="dinh-bien-note"></textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('dinhBienModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CV Modal -->
    <div id="cvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Th√¥ng tin CV ·ª©ng vi√™n</h3><button class="modal-close"
                    onclick="closeModal('cvModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="cvForm">
                    <input type="hidden" id="cv-id">
                    <div class="form-row">
                        <div class="form-group"><label>H·ªç v√† t√™n *</label><input type="text" id="cv-name" required>
                        </div>
                        <div class="form-group"><label>S·ªë ƒëi·ªán tho·∫°i *</label><input type="text" id="cv-phone" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" id="cv-email"></div>
                        <div class="form-group"><label>Ngu·ªìn CV</label><select id="cv-source">
                                <option value="Facebook">Facebook</option>
                                <option value="Website">Website</option>
                                <option value="Gi·ªõi thi·ªáu">Gi·ªõi thi·ªáu</option>
                                <option value="TopCV">TopCV</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>V·ªã tr√≠ ·ª©ng tuy·ªÉn *</label><select id="cv-position" required>
                                <option value="">Ch·ªçn v·ªã tr√≠</option>
                            </select></div>
                        <div class="form-group"><label>B·ªô ph·∫≠n</label><select id="cv-dept">
                                <option value="">Ch·ªçn b·ªô ph·∫≠n</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="cv-status">
                                <option value="CV ti·∫øp nh·∫≠n">CV ti·∫øp nh·∫≠n</option>
                                <option value="CV ƒë√£ li√™n h·ªá">CV ƒë√£ li√™n h·ªá</option>
                                <option value="CV ph·ªèng v·∫•n">CV ph·ªèng v·∫•n</option>
                                <option value="CV tr√∫ng tuy·ªÉn">CV tr√∫ng tuy·ªÉn</option>
                                <option value="CV kh√¥ng ph√π h·ª£p">CV kh√¥ng ph√π h·ª£p</option>
                            </select></div>
                        <div class="form-group"><label>Ng√†y ti·∫øp nh·∫≠n</label><input type="date" id="cv-date"></div>
                    </div>
                    <div class="form-group"><label>Ghi ch√∫</label><textarea id="cv-note"></textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('cvModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Competency Framework Modal -->
    <div id="competencyFrameworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-graduation-cap"></i> Khai b√°o khung nƒÉng l·ª±c</h3><button class="modal-close"
                    onclick="closeModal('competencyFrameworkModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="competencyFrameworkForm">
                    <input type="hidden" id="competency-id">
                    <div class="form-row">
                        <div class="form-group"><label>B·ªô ph·∫≠n *</label><select id="competency-dept" required>
                                <option value="">Ch·ªçn b·ªô ph·∫≠n</option>
                                <option value="MKT">Marketing</option>
                                <option value="Sale">Sale</option>
                                <option value="V·∫≠n ƒë∆°n">V·∫≠n ƒë∆°n</option>
                            </select></div>
                        <div class="form-group"><label>V·ªã tr√≠ *</label><select id="competency-position" required>
                                <option value="">Ch·ªçn v·ªã tr√≠</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Nh√≥m nƒÉng l·ª±c *</label><select id="competency-group" required>
                                <option value="Chuy√™n m√¥n">Chuy√™n m√¥n</option>
                                <option value="L√£nh ƒë·∫°o">L√£nh ƒë·∫°o</option>
                                <option value="C√° nh√¢n">C√° nh√¢n</option>
                            </select></div>
                        <div class="form-group"><label>T√™n nƒÉng l·ª±c *</label><input type="text" id="competency-name"
                                required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Level y√™u c·∫ßu (1-5) *</label><select id="competency-level"
                                required>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select></div>
                        <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="competency-status">
                                <option value="√Åp d·ª•ng">√Åp d·ª•ng</option>
                                <option value="Ng·ª´ng">Ng·ª´ng</option>
                            </select></div>
                    </div>
                    <div class="form-group"><label>Ghi ch√∫</label><textarea id="competency-note"></textarea></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('competencyFrameworkModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- KPI Catalog Modal -->
    <div id="kpiCatalogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bullseye"></i> Danh m·ª•c KPI</h3><button class="modal-close"
                    onclick="closeModal('kpiCatalogModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="kpiCatalogForm">
                    <input type="hidden" id="kpi-catalog-id">
                    <div class="form-row">
                        <div class="form-group"><label>M√£ KPI *</label><input type="text" id="kpi-code" required
                                placeholder="VD: KPI-M1"></div>
                        <div class="form-group"><label>T√™n KPI *</label><input type="text" id="kpi-catalog-name"
                                required placeholder="VD: Doanh thu"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ƒê∆°n v·ªã ƒëo</label><input type="text" id="kpi-unit"
                                placeholder="VD: VNƒê, %, Lead"></div>
                        <div class="form-group"><label>ƒê·ªëi t∆∞·ª£ng √°p d·ª•ng</label><select id="kpi-target-group">
                                <option value="C√° nh√¢n MKT">C√° nh√¢n MKT</option>
                                <option value="C√° nh√¢n Sale">C√° nh√¢n Sale</option>
                                <option value="B·ªô ph·∫≠n MKT">B·ªô ph·∫≠n MKT</option>
                                <option value="B·ªô ph·∫≠n Sale">B·ªô ph·∫≠n Sale</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Tr·ªçng s·ªë (%)</label><input type="number" id="kpi-weight"
                                value="50" min="0" max="100"></div>
                        <div class="form-group"><label>Th√°ng √°p d·ª•ng</label><input type="month" id="kpi-apply-month">
                        </div>
                    </div>
                    <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="kpi-catalog-status">
                            <option value="ƒêang √°p d·ª•ng">ƒêang √°p d·ª•ng</option>
                            <option value="Ng·ª´ng √°p d·ª•ng">Ng·ª´ng √°p d·ª•ng</option>
                        </select></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('kpiCatalogModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- BHXH Modal -->
    <div id="bhxhModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-hospital"></i> Th√¥ng tin BHXH</h3><button class="modal-close"
                    onclick="closeModal('bhxhModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bhxhForm">
                    <input type="hidden" id="bhxh-id">
                    <div class="form-group"><label>Nh√¢n vi√™n *</label><select id="bhxh-employee" required></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>S·ªë s·ªï BHXH *</label><input type="text" id="bhxh-number" required>
                        </div>
                        <div class="form-group"><label>Ng√†y tham gia</label><input type="date" id="bhxh-join-date">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>M·ª©c l∆∞∆°ng ƒë√≥ng BHXH (VNƒê)</label><input type="number"
                                id="bhxh-salary" value="0"></div>
                        <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="bhxh-status">
                                <option value="ƒêang tham gia">ƒêang tham gia</option>
                                <option value="D·ª´ng ƒë√≥ng">D·ª´ng ƒë√≥ng</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>T·ª∑ l·ªá NLƒê (%)</label><input type="number" id="bhxh-rate-employee"
                                value="10.5" step="0.5"></div>
                        <div class="form-group"><label>T·ª∑ l·ªá DN (%)</label><input type="number" id="bhxh-rate-company"
                                value="21.5" step="0.5"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('bhxhModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tax Modal -->
    <div id="taxModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Th√¥ng tin Thu·∫ø TNCN</h3><button class="modal-close"
                    onclick="closeModal('taxModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taxForm">
                    <input type="hidden" id="tax-id">
                    <div class="form-group"><label>Nh√¢n vi√™n *</label><select id="tax-employee" required></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>M√£ s·ªë thu·∫ø TNCN</label><input type="text" id="tax-code"></div>
                        <div class="form-group"><label>Bi·ªÉu thu·∫ø</label><select id="tax-type">
                                <option value="L≈©y ti·∫øn">L≈©y ti·∫øn</option>
                                <option value="To√†n ph·∫ßn">To√†n ph·∫ßn (10%)</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Gi·∫£m tr·ª´ b·∫£n th√¢n (VNƒê)</label><input type="number"
                                id="tax-personal-deduction" value="11000000"></div>
                        <div class="form-group"><label>K·ª≥ √°p d·ª•ng</label><input type="month" id="tax-period"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('taxModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dependent Modal -->
    <div id="dependentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-users"></i> Ng∆∞·ªùi ph·ª• thu·ªôc</h3><button class="modal-close"
                    onclick="closeModal('dependentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="dependentForm">
                    <input type="hidden" id="dependent-id">
                    <div class="form-group"><label>Nh√¢n vi√™n *</label><select id="dependent-employee" required></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>H·ªç t√™n NPT *</label><input type="text" id="dependent-name"
                                required></div>
                        <div class="form-group"><label>Quan h·ªá</label><select id="dependent-relation">
                                <option value="Con">Con</option>
                                <option value="V·ª£/Ch·ªìng">V·ª£/Ch·ªìng</option>
                                <option value="B·ªë/M·∫π">B·ªë/M·∫π</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ng√†y sinh</label><input type="date" id="dependent-dob"></div>
                        <div class="form-group"><label>CCCD/CMND</label><input type="text" id="dependent-cccd"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Gi·∫£m tr·ª´ t·ª´</label><input type="date" id="dependent-from"></div>
                        <div class="form-group"><label>Gi·∫£m tr·ª´ ƒë·∫øn</label><input type="date" id="dependent-to"></div>
                    </div>
                    <div class="form-group"><label>Tr·∫°ng th√°i</label><select id="dependent-status">
                            <option value="ƒêang √°p d·ª•ng">ƒêang √°p d·ª•ng</option>
                            <option value="Ng·ª´ng √°p d·ª•ng">Ng·ª´ng √°p d·ª•ng</option>
                        </select></div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('dependentModal')">H·ªßy</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i>L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const FIREBASE_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app';
        let employees = [], salaryGrades = [], trainings = [], evaluations = [], kpis = [], tasks = [], attendances = [];
        let avatarBase64 = '', filesBase64 = [];
        let nhanSuData = [], isSyncingNhanSu = false, currentEditItem = null, currentDetailItem = null;
        let editAvatarDataUrl = '', editImages = [], editFiles = [], selectedEditImages = [], selectedEditFiles = [];
        // New data arrays
        let dinhBiens = [], cvList = [], statusHistory = [], employeeSalaries = [], promotionHistory = [];
        let competencyFramework = [], kpiCatalog = [], kpiConversions = [], bhxhList = [], taxList = [], dependents = [];

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                try {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    item.classList.add('active');
                    const pageId = item.dataset.page;
                    if (!pageId) {
                        console.warn('Nav item has no data-page attribute');
                        return;
                    }
                    const pageElement = document.getElementById(pageId);
                    if (pageElement) {
                        pageElement.classList.add('active');
                        // Auto-sync nh√¢n s·ª± when navigating to employees page
                        if (pageId === 'employees') {
                            // Use setTimeout to ensure DOM is ready
                            setTimeout(() => {
                                try {
                                    syncNhanSu();
                                    // Reset to first tab
                                    showEmployeeTab('list');
                                } catch (e) {
                                    console.error('Error syncing nh√¢n s·ª±:', e);
                                    showToast('L·ªói khi t·∫£i d·ªØ li·ªáu nh√¢n s·ª±: ' + (e.message || 'Unknown error'), true);
                                }
                            }, 100);
                        } else if (pageId === 'dashboard' || pageId === 'overview') {
                            // Refresh dashboard when navigating to dashboard page
                            setTimeout(() => {
                                try {
                                    renderDashboard();
                                } catch (e) {
                                    console.error('Error rendering dashboard:', e);
                                }
                            }, 100);
                        }
                    } else {
                        console.error('Page not found:', pageId);
                        showToast('Kh√¥ng t√¨m th·∫•y trang: ' + pageId, true);
                    }
                } catch (e) {
                    console.error('Error in navigation:', e);
                    showToast('L·ªói khi chuy·ªÉn trang: ' + (e.message || 'Unknown error'), true);
                }
            });
        });

        // Modal functions
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
            const form = document.getElementById(id).querySelector('form');
            if (form) form.reset();
            avatarBase64 = ''; filesBase64 = [];
            document.getElementById('avatar-preview')?.innerHTML && (document.getElementById('avatar-preview').innerHTML = '');
            document.getElementById('files-preview')?.innerHTML && (document.getElementById('files-preview').innerHTML = '');
        }

        // Toast
        function showToast(msg, isError = false) {
            try {
                const toast = document.getElementById('toast');
                if (!toast) {
                    console.warn('Toast element not found, logging instead:', msg);
                    return;
                }
                toast.textContent = msg || '';
                toast.className = 'toast show' + (isError ? ' error' : '');
                setTimeout(() => {
                    if (toast) toast.classList.remove('show');
                }, 3000);
            } catch (e) {
                console.error('Error showing toast:', e);
            }
        }

        // Firebase API
        async function fbGet(path) {
            const res = await fetch(`${FIREBASE_URL}/${path}.json`);
            return res.json();
        }
        async function fbSet(path, data) {
            await fetch(`${FIREBASE_URL}/${path}.json`, { method: 'PUT', body: JSON.stringify(data) });
        }
        async function fbPush(path, data) {
            const res = await fetch(`${FIREBASE_URL}/${path}.json`, { method: 'POST', body: JSON.stringify(data) });
            return res.json();
        }
        async function fbDelete(path) {
            await fetch(`${FIREBASE_URL}/${path}.json`, { method: 'DELETE' });
        }
        async function fbUpdate(path, data) {
            await fetch(`${FIREBASE_URL}/${path}.json`, { method: 'PATCH', body: JSON.stringify(data) });
        }

        // ========== TAB NAVIGATION FUNCTIONS ==========
        function showEmployeeTab(tab) {
            try {
                const listTab = document.getElementById('employee-list-tab');
                const recruitmentTab = document.getElementById('employee-recruitment-tab');
                const statusHistoryTab = document.getElementById('employee-status-history-tab');

                if (!listTab || !recruitmentTab || !statusHistoryTab) {
                    console.error('Tab elements not found');
                    return;
                }

                // Hide all tabs
                listTab.style.display = 'none';
                recruitmentTab.style.display = 'none';
                statusHistoryTab.style.display = 'none';

                // Show selected tab
                if (tab === 'list') {
                    listTab.style.display = 'block';
                } else if (tab === 'recruitment') {
                    recruitmentTab.style.display = 'block';
                    loadRecruitmentData();
                } else if (tab === 'status-history') {
                    statusHistoryTab.style.display = 'block';
                    loadStatusHistory();
                }

                // Update tab buttons
                document.querySelectorAll('#employees .tabs .tab').forEach((t, i) => {
                    const tabs = ['list', 'recruitment', 'status-history'];
                    t.classList.toggle('active', tabs[i] === tab);
                });
            } catch (error) {
                console.error('Error in showEmployeeTab:', error);
                showToast('L·ªói khi chuy·ªÉn tab: ' + error.message, true);
            }
        }

        function showKPITab(tab) {
            document.getElementById('kpi-catalog-tab').style.display = tab === 'catalog' ? 'block' : 'none';
            document.getElementById('kpi-assign-tab').style.display = tab === 'assign' ? 'block' : 'none';
            document.getElementById('kpi-conversion-tab').style.display = tab === 'conversion' ? 'block' : 'none';
            document.getElementById('kpi-results-tab').style.display = tab === 'results' ? 'block' : 'none';
            document.querySelectorAll('#kpi .tabs .tab').forEach((t, i) => {
                const tabs = ['catalog', 'assign', 'conversion', 'results'];
                t.classList.toggle('active', tabs[i] === tab);
            });
        }

        // ========== QTNS NH√ÇN S·ª∞ FUNCTIONS ==========
        function escapeHtml(str) {
            return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
        }

        function renderNhanSuTable(data) {
            try {
                const container = document.getElementById('nhanSuTableContainer');
                if (!container) {
                    console.warn('nhanSuTableContainer not found');
                    return;
                }

                if (data === null || data === undefined) {
                    container.innerHTML = '<div class="loadingState">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
                    return;
                }

                container.style.overflowX = "auto";

                let items = [];
                if (Array.isArray(data)) {
                    items = data.filter(item => item !== null && item !== undefined);
                } else if (typeof data === "object" && data !== null) {
                    items = Object.entries(data)
                        .filter(([id, item]) => item !== null && item !== undefined)
                        .map(([id, item]) => ({ id, ...(item || {}) }));
                }

                if (items.length === 0) {
                    container.innerHTML = '<div class="emptyState"><i class="fas fa-users" style="font-size:3rem;color:var(--border);margin-bottom:15px;display:block;"></i>Ch∆∞a c√≥ d·ªØ li·ªáu nh√¢n s·ª±.</div>';
                    return;
                }

                // Detect field names
                const detectField = (variants, items) => {
                    for (const variant of variants) {
                        if (items.some((item) => item && item.hasOwnProperty(variant))) return variant;
                    }
                    return null;
                };

                const nameField = detectField(["ho_va_ten", "H·ªç_v√†_t√™n", "H·ªç v√† t√™n", "T√™n", "Name", "name"], items);
                const emailField = detectField(["email", "Email"], items);
                const sdtField = detectField(["sƒët", "sdt", "SƒêT", "phone"], items);
                const chiNhanhField = detectField(["chi_nhanh", "Chi nh√°nh", "Branch"], items);
                const boPhanField = detectField(["bo_phan", "B·ªô ph·∫≠n", "department"], items);
                const viTriField = detectField(["vi_tri", "V·ªã tr√≠", "position"], items);
                const teamField = detectField(["team", "Team"], items);
                const avatarField = detectField(["avatarDataUrl", "avatarUrl", "avatar"], items);
                const leaderField = detectField(["Leader", "leader", "isLeader"], items);

                const columns = [
                    { key: avatarField, label: "·∫¢nh", type: "avatar" },
                    { key: nameField, label: "H·ªç v√† t√™n", type: "text" },
                    { key: emailField, label: "Email", type: "text" },
                    { key: sdtField, label: "SƒêT", type: "text" },
                    { key: boPhanField, label: "B·ªô ph·∫≠n", type: "text" },
                    { key: viTriField, label: "V·ªã tr√≠", type: "text" },
                    { key: teamField, label: "Team", type: "text" },
                ];

                // Populate department filter
                const deptSet = new Set();
                items.forEach(item => {
                    if (boPhanField && item[boPhanField]) deptSet.add(item[boPhanField]);
                });
                const filterDept = document.getElementById('filter-dept');
                if (filterDept) {
                    filterDept.innerHTML = '<option value="">T·∫•t c·∫£ ph√≤ng ban</option>' +
                        Array.from(deptSet).sort().map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('');
                }

                const isLeader = (item) => {
                    if (leaderField) {
                        const value = item[leaderField];
                        if (typeof value === "boolean") return value === true;
                        if (typeof value === "string") {
                            const lower = value.toLowerCase().trim();
                            return lower === "leader" || lower === "true" || lower.includes("leader") || lower.includes("tr∆∞·ªüng");
                        }
                    }
                    return false;
                };

                // ========== GROUP BY CHI NH√ÅNH (HCM / H√† N·ªôi) ==========
                const hcmItems = items.filter(item => chiNhanhField && item[chiNhanhField] === "HCM");
                const hanoiItems = items.filter(item => chiNhanhField && item[chiNhanhField] === "H√† N·ªôi");
                const otherItems = items.filter(item => !chiNhanhField || (item[chiNhanhField] !== "HCM" && item[chiNhanhField] !== "H√† N·ªôi"));

                // Group by B·ªô ph·∫≠n within each Chi nh√°nh
                const groupByBoPhan = (itemsList) => {
                    const grouped = {};
                    itemsList.forEach((item) => {
                        const boPhan = boPhanField ? (item[boPhanField] || "Kh√°c") : "T·∫•t c·∫£";
                        if (!grouped[boPhan]) grouped[boPhan] = [];
                        grouped[boPhan].push(item);
                    });
                    // Sort items within each group (Leaders first)
                    Object.keys(grouped).forEach((boPhan) => {
                        grouped[boPhan].sort((a, b) => {
                            const aIsLead = isLeader(a) || (viTriField && String(a[viTriField] || "").toLowerCase() === "leader");
                            const bIsLead = isLeader(b) || (viTriField && String(b[viTriField] || "").toLowerCase() === "leader");
                            if (aIsLead && !bIsLead) return -1;
                            if (!aIsLead && bIsLead) return 1;
                            return 0;
                        });
                    });
                    return grouped;
                };

                const hcmGrouped = groupByBoPhan(hcmItems);
                const hanoiGrouped = groupByBoPhan(hanoiItems);
                const otherGrouped = groupByBoPhan(otherItems);

                // Count by department for comparison report
                const hcmDeptCount = {};
                const hanoiDeptCount = {};
                hcmItems.forEach(item => {
                    const dept = boPhanField ? (item[boPhanField] || "Kh√°c") : "Kh√°c";
                    hcmDeptCount[dept] = (hcmDeptCount[dept] || 0) + 1;
                });
                hanoiItems.forEach(item => {
                    const dept = boPhanField ? (item[boPhanField] || "Kh√°c") : "Kh√°c";
                    hanoiDeptCount[dept] = (hanoiDeptCount[dept] || 0) + 1;
                });
                const allDepts = [...new Set([...Object.keys(hcmDeptCount), ...Object.keys(hanoiDeptCount)])].sort();

                // ========== B√ÅO C√ÅO SO S√ÅNH NH√ÇN S·ª∞ ==========
                const comparisonReport = `
        <div class="comparison-report" style="background:linear-gradient(135deg,#f8fafc,#e2e8f0);border-radius:12px;padding:20px;margin-bottom:24px;border:1px solid var(--border);">
            <h3 style="margin:0 0 16px;color:var(--text);display:flex;align-items:center;gap:10px;">
                <i class="fas fa-chart-bar" style="color:var(--primary);"></i>
                B√°o c√°o so s√°nh nh√¢n s·ª± HCM vs H√† N·ªôi
            </h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px;">
                <div style="background:#fff;border-radius:10px;padding:16px;text-align:center;border-left:4px solid var(--secondary);box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size:2rem;font-weight:800;color:var(--secondary);">${hcmItems.length}</div>
                    <div style="color:var(--text-light);font-size:13px;margin-top:4px;">üèôÔ∏è HCM</div>
                </div>
                <div style="background:#fff;border-radius:10px;padding:16px;text-align:center;border-left:4px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size:2rem;font-weight:800;color:var(--accent);">${hanoiItems.length}</div>
                    <div style="color:var(--text-light);font-size:13px;margin-top:4px;">üèõÔ∏è H√† N·ªôi</div>
                </div>
                <div style="background:#fff;border-radius:10px;padding:16px;text-align:center;border-left:4px solid var(--primary);box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size:2rem;font-weight:800;color:var(--primary);">${items.length}</div>
                    <div style="color:var(--text-light);font-size:13px;margin-top:4px;">üìä T·ªïng c·ªông</div>
                </div>
            </div>
            <div style="background:#fff;border-radius:10px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <h4 style="margin:0 0 12px;font-size:14px;color:var(--text);">So s√°nh theo Ph√≤ng ban</h4>
                <table style="width:100%;border-collapse:collapse;font-size:13px;">
                    <thead>
                        <tr style="background:var(--bg);">
                            <th style="padding:10px;text-align:left;border-bottom:2px solid var(--border);font-weight:700;">Ph√≤ng ban</th>
                            <th style="padding:10px;text-align:center;border-bottom:2px solid var(--border);color:var(--secondary);font-weight:700;">üèôÔ∏è HCM</th>
                            <th style="padding:10px;text-align:center;border-bottom:2px solid var(--border);color:var(--accent);font-weight:700;">üèõÔ∏è H√† N·ªôi</th>
                            <th style="padding:10px;text-align:center;border-bottom:2px solid var(--border);font-weight:700;">Ch√™nh l·ªách</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allDepts.map(dept => {
                    const hcm = hcmDeptCount[dept] || 0;
                    const hanoi = hanoiDeptCount[dept] || 0;
                    const diff = hcm - hanoi;
                    const diffColor = diff > 0 ? 'var(--secondary)' : diff < 0 ? 'var(--accent)' : 'var(--text-light)';
                    const diffText = diff > 0 ? `+${diff} HCM` : diff < 0 ? `+${Math.abs(diff)} HN` : '=';
                    return `
                                <tr>
                                    <td style="padding:10px;border-bottom:1px solid var(--border);font-weight:500;">${escapeHtml(dept)}</td>
                                    <td style="padding:10px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:var(--secondary);">${hcm}</td>
                                    <td style="padding:10px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:var(--accent);">${hanoi}</td>
                                    <td style="padding:10px;text-align:center;border-bottom:1px solid var(--border);font-weight:600;color:${diffColor};">${diffText}</td>
                                </tr>
                            `;
                }).join('')}
                        <tr style="background:var(--bg);font-weight:700;">
                            <td style="padding:10px;border-top:2px solid var(--border);">T·ªîNG C·ªòNG</td>
                            <td style="padding:10px;text-align:center;border-top:2px solid var(--border);color:var(--secondary);">${hcmItems.length}</td>
                            <td style="padding:10px;text-align:center;border-top:2px solid var(--border);color:var(--accent);">${hanoiItems.length}</td>
                            <td style="padding:10px;text-align:center;border-top:2px solid var(--border);">
                                ${hcmItems.length !== hanoiItems.length ?
                        (hcmItems.length > hanoiItems.length ?
                            `<span style="color:var(--secondary);">+${hcmItems.length - hanoiItems.length} HCM</span>` :
                            `<span style="color:var(--accent);">+${hanoiItems.length - hcmItems.length} HN</span>`)
                        : '<span style="color:var(--text-light);">=</span>'}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;

                // ========== RENDER TABLES BY CHI NH√ÅNH ==========
                const renderBranchTables = (branchItems, branchGrouped, branchName, branchIcon, branchColor) => {
                    if (branchItems.length === 0) return '';
                    const sortedDepts = Object.keys(branchGrouped).sort((a, b) => a.localeCompare(b, "vi"));
                    let branchIdx = 0;

                    return `
            <div class="branch-section" style="margin-bottom:32px;">
                <div style="background:linear-gradient(135deg,${branchColor}15,${branchColor}05);border-radius:12px;padding:16px 20px;margin-bottom:16px;border:2px solid ${branchColor}30;display:flex;align-items:center;justify-content:space-between;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:2rem;">${branchIcon}</span>
                        <div>
                            <h3 style="margin:0;color:${branchColor};font-size:1.3rem;">${branchName}</h3>
                            <p style="margin:4px 0 0;color:var(--text-light);font-size:13px;">T·ªïng s·ªë: <strong style="color:${branchColor};">${branchItems.length}</strong> nh√¢n vi√™n</p>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:2.5rem;font-weight:800;color:${branchColor};">${branchItems.length}</div>
                    </div>
                </div>
                ${sortedDepts.map(dept => {
                        const deptItems = branchGrouped[dept];
                        return `
                        <div class="groupHeader" style="background:linear-gradient(90deg,${branchColor}20,transparent);border-color:${branchColor}40;">${escapeHtml(dept)} (${deptItems.length} ng∆∞·ªùi)</div>
                        <table class="dataTable">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    ${columns.map((col) => `<th>${escapeHtml(col.label)}</th>`).join("")}
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${deptItems.map((item, deptItemIdx) => {
                            branchIdx++;
                            const isLead = isLeader(item) || (viTriField && String(item[viTriField] || "").toLowerCase() === "leader");
                            const rowClass = isLead ? ' class="leader"' : "";
                            // Find item index in main items array by id
                            let itemIndex = -1;
                            if (item.id) {
                                itemIndex = items.findIndex(i => i && (i.id === item.id || (i.id && String(i.id) === String(item.id))));
                            }
                            if (itemIndex === -1) {
                                // Fallback: try to find by comparing key fields
                                const itemName = item[nameField] || item.ho_va_ten || item.name || '';
                                const itemEmail = item[emailField] || item.email || '';
                                itemIndex = items.findIndex(i => {
                                    if (!i) return false;
                                    const iName = i[nameField] || i.ho_va_ten || i.name || '';
                                    const iEmail = i[emailField] || i.email || '';
                                    return iName === itemName && iEmail === itemEmail;
                                });
                            }
                            if (itemIndex === -1) itemIndex = branchIdx - 1; // Fallback to branch index
                            const itemId = item.id || String(branchIdx);
                            return `
                                    <tr${rowClass} data-item-index="${itemIndex}" data-item-id="${escapeHtml(String(itemId))}" style="cursor:pointer;">
                                        <td>${branchIdx}</td>
                                        ${columns.map((col) => {
                                let value = col.key ? item[col.key] : null;
                                if ((value === null || value === undefined || value === "") && col.key === "sƒët") {
                                    value = item["sdt"] || item["SƒêT"];
                                }
                                let displayValue = "‚Äî";
                                if (value !== null && value !== undefined && value !== "") {
                                    if (col.type === "avatar") {
                                        const stringValue = String(value);
                                        const isImg = stringValue.startsWith("data:") || stringValue.startsWith("http");
                                        displayValue = isImg ? `<img src="${escapeHtml(stringValue)}" alt="Avatar" style="width:40px;height:40px;object-fit:cover;border-radius:8px;border:1px solid var(--border);" />` : escapeHtml(stringValue);
                                    } else if (nameField && col.key === nameField) {
                                        displayValue = `<span class="nameLink" data-item-index="${itemIndex}">${escapeHtml(String(value))}</span>`;
                                    } else {
                                        displayValue = escapeHtml(String(value));
                                    }
                                }
                                return `<td>${displayValue}</td>`;
                            }).join("")}
                                        <td style="white-space:nowrap;">
                                            <div class="actions">
                                                <button class="view btn-view-item" data-item-index="${itemIndex}"><i class="fas fa-eye"></i></button>
                                                <button class="edit btn-edit-item" data-item-index="${itemIndex}"><i class="fas fa-edit"></i></button>
                                                <button class="delete btn-delete-item" data-item-index="${itemIndex}" data-item-id="${escapeHtml(String(itemId))}"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                `}).join("")}
                            </tbody>
                        </table>
                    `;
                    }).join("")}
            </div>
        `;
                };

                const hcmHtml = renderBranchTables(hcmItems, hcmGrouped, "Chi nh√°nh HCM (TP. H·ªì Ch√≠ Minh)", "üèôÔ∏è", "#f37021");
                const hanoiHtml = renderBranchTables(hanoiItems, hanoiGrouped, "Chi nh√°nh H√† N·ªôi", "üèõÔ∏è", "#1a73e8");
                const otherHtml = otherItems.length > 0 ? renderBranchTables(otherItems, otherGrouped, "Kh√°c", "üìç", "#666") : '';

                container.innerHTML = comparisonReport + hcmHtml + hanoiHtml + otherHtml;
                nhanSuData = items;

                // Add click handlers
                setTimeout(() => {
                    try {
                        container.querySelectorAll(".nameLink, .btn-view-item").forEach((el) => {
                            el.addEventListener("click", (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const itemIndex = Number(el.getAttribute("data-item-index"));
                                if (itemIndex >= 0 && itemIndex < items.length) openNhanVienDetail(items[itemIndex]);
                            });
                        });

                        container.querySelectorAll(".btn-edit-item").forEach((btn) => {
                            btn.addEventListener("click", (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const itemIndex = Number(btn.getAttribute("data-item-index"));
                                if (itemIndex >= 0 && itemIndex < items.length) openEditNhanVienModal(items[itemIndex]);
                            });
                        });

                        container.querySelectorAll(".btn-delete-item").forEach((btn) => {
                            btn.addEventListener("click", async (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const itemIndex = Number(btn.getAttribute("data-item-index"));
                                const itemId = btn.getAttribute("data-item-id");
                                if (itemIndex >= 0 && itemIndex < items.length) {
                                    const item = items[itemIndex];
                                    const name = item.ho_va_ten || item.name || item.T√™n || "nh√¢n vi√™n n√†y";
                                    if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n "${name}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                                        try {
                                            await fbDelete(`employees/${itemId}`);
                                            showToast(`ƒê√£ x√≥a nh√¢n vi√™n "${name}"`);
                                            await syncNhanSu();
                                        } catch (error) {
                                            showToast(`L·ªói: ${error.message}`, true);
                                        }
                                    }
                                }
                            });
                        });
                    } catch (handlerError) {
                        console.error('Error setting up event handlers:', handlerError);
                    }
                }, 50);
            } catch (e) {
                console.error('Error in renderNhanSuTable:', e);
                const container = document.getElementById('nhanSuTableContainer');
                if (container) {
                    container.innerHTML = `<div class="emptyState" style="color:var(--danger);">
                <i class="fas fa-exclamation-circle" style="font-size:2rem;margin-bottom:10px;display:block;"></i>
                L·ªói khi hi·ªÉn th·ªã d·ªØ li·ªáu: ${escapeHtml(e.message || "Unknown error")}
            </div>`;
                }
                showToast('L·ªói khi render b·∫£ng nh√¢n s·ª±: ' + (e.message || 'Unknown error'), true);
            }
        }

        async function syncNhanSu() {
            if (isSyncingNhanSu) return;
            isSyncingNhanSu = true;
            const btnRefresh = document.getElementById('btnRefreshNhanSu');
            if (btnRefresh) btnRefresh.disabled = true;

            const container = document.getElementById('nhanSuTableContainer');
            if (container) container.innerHTML = '<div class="loadingState"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...</div>';

            try {
                const raw = await fbGet("employees");
                // Update nhanSuData with the raw data
                if (raw === null || raw === undefined) {
                    nhanSuData = [];
                    employees = [];
                } else if (Array.isArray(raw)) {
                    nhanSuData = raw;
                    employees = raw;
                } else if (typeof raw === "object") {
                    nhanSuData = Object.entries(raw).map(([k, v]) => ({ ...v, id: k }));
                    employees = nhanSuData;
                } else {
                    nhanSuData = [];
                    employees = [];
                }
                renderNhanSuTable(nhanSuData);
                // Update dashboard stats
                renderDashboard();
            } catch (err) {
                console.error("Error loading nh√¢n s·ª±:", err);
                nhanSuData = [];
                employees = [];
                if (container) {
                    container.innerHTML = `<div class="emptyState" style="color:var(--danger);">
                <i class="fas fa-exclamation-circle" style="font-size:2rem;margin-bottom:10px;display:block;"></i>
                L·ªói khi t·∫£i d·ªØ li·ªáu: ${escapeHtml(err.message || "Unknown error")}
            </div>`;
                }
                showToast('L·ªói khi t·∫£i d·ªØ li·ªáu nh√¢n s·ª±: ' + (err.message || 'Unknown error'), true);
            } finally {
                isSyncingNhanSu = false;
                if (btnRefresh) btnRefresh.disabled = false;
            }
        }

        function filterNhanSu() {
            try {
                if (!Array.isArray(nhanSuData)) {
                    nhanSuData = [];
                }

                const search = document.getElementById('search-employee')?.value.toLowerCase() || '';
                const branch = document.getElementById('filter-branch')?.value || '';
                const dept = document.getElementById('filter-dept')?.value || '';
                const status = document.getElementById('filter-status')?.value || '';

                const filtered = nhanSuData.filter(item => {
                    if (!item) return false;
                    const nameField = item.ho_va_ten || item.name || item.T√™n || "";
                    const matchSearch = !search || nameField.toLowerCase().includes(search) ||
                        (item.email && item.email.toLowerCase().includes(search)) ||
                        (item.sƒët && String(item.sƒët || '').includes(search)) ||
                        (item.sdt && String(item.sdt || '').includes(search));
                    const matchBranch = !branch || item.chi_nhanh === branch;
                    const matchDept = !dept || item.bo_phan === dept;
                    const matchStatus = !status || item.trang_thai === status || item.status === status;
                    return matchSearch && matchBranch && matchDept && matchStatus;
                });

                renderNhanSuTable(filtered.length > 0 ? filtered : (search || branch || dept || status ? [] : nhanSuData));
            } catch (e) {
                console.error('Error in filterNhanSu:', e);
                showToast('L·ªói khi l·ªçc d·ªØ li·ªáu: ' + (e.message || 'Unknown error'), true);
            }
        }

        // Detail Modal
        function openNhanVienDetail(item) {
            const modal = document.getElementById('nhanVienDetailModal');
            if (!modal) return;
            currentDetailItem = item;
            const nameField = item.ho_va_ten || item.T√™n || item.name || "Nh√¢n vi√™n";
            document.getElementById('detailModalTitle').textContent = `Th√¥ng tin: ${nameField}`;
            renderNhanVienDetail(item);
            modal.showModal();
        }

        function closeNhanVienDetail() {
            const modal = document.getElementById('nhanVienDetailModal');
            if (modal) modal.close();
            currentDetailItem = null;
        }

        function renderNhanVienDetail(item) {
            const container = document.getElementById('detailContent');
            if (!container) return;

            const avatarUrl = item.avatarDataUrl || item.avatarUrl || item.avatar || "";
            const nameField = item.ho_va_ten || item.T√™n || item.name || "Th√¥ng tin chi ti·∫øt";

            const fieldNameMap = {
                "bo_phan": "B·ªô ph·∫≠n", "vi_tri": "V·ªã tr√≠", "vi_tri_van_don": "V·ªã tr√≠ v·∫≠n ƒë∆°n",
                "ca": "Ca", "chi_nhanh": "Chi nh√°nh", "email": "Email", "ho_va_ten": "H·ªç v√† t√™n",
                "link_van_don": "Link v·∫≠n ƒë∆°n", "mat_khau": "M·∫≠t kh·∫©u", "sƒët": "S·ªë ƒëi·ªán tho·∫°i",
                "sdt": "S·ªë ƒëi·ªán tho·∫°i", "tai_khoan": "T√†i kho·∫£n", "team": "Team", "team_sale_mar": "Team_Sale_Mar"
            };

            const excludeFields = ["id", "avatarDataUrl", "avatarUrl", "avatar", "images", "files"];
            const allFields = Object.entries(item).filter(([key]) => !excludeFields.includes(key));

            container.innerHTML = `
        <div style="display:flex;gap:24px;align-items:flex-start;">
            <div style="flex-shrink:0;">
                ${avatarUrl ? `<img src="${escapeHtml(avatarUrl)}" alt="Avatar" style="width:120px;height:120px;object-fit:cover;border-radius:12px;border:2px solid var(--primary);" />` :
                    `<div style="width:120px;height:120px;border:2px dashed var(--border);border-radius:12px;display:grid;place-items:center;background:#f8fafc;color:var(--text-light);font-size:12px;">Ch∆∞a c√≥ ·∫£nh</div>`}
            </div>
            <div style="flex:1;">
                <h3 style="margin:0 0 16px;color:var(--primary);">${escapeHtml(nameField)}</h3>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                    ${allFields.map(([key, value]) => {
                        const displayKey = fieldNameMap[key] || fieldNameMap[key.toLowerCase()] || key;
                        const displayValue = typeof value === "object" ? JSON.stringify(value) : String(value || "‚Äî");
                        const isLongField = key.includes("link") || displayValue.length > 50;
                        return `
                            <div style="${isLongField ? "grid-column:1/-1;" : ""} padding:8px;background:rgba(0,177,79,0.05);border-radius:8px;border-left:3px solid var(--primary);">
                                <strong style="font-size:11px;color:var(--text-light);text-transform:uppercase;">${escapeHtml(displayKey)}</strong>
                                <div style="margin-top:4px;font-size:13px;word-break:break-word;">${escapeHtml(displayValue)}</div>
                            </div>
                        `;
                    }).join("")}
                </div>
            </div>
        </div>
        <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn btn-primary" onclick="openEditNhanVienModal(currentDetailItem);closeNhanVienDetail();"><i class="fas fa-edit"></i> Ch·ªânh s·ª≠a</button>
        </div>
    `;
        }

        // Edit Modal
        function openEditNhanVienModal(item) {
            const modal = document.getElementById('editNhanVienModal');
            if (!modal) return;
            currentEditItem = item;
            const nameField = item.ho_va_ten || item.name || item.T√™n || "Nh√¢n vi√™n";
            document.getElementById('editModalTitle').textContent = `Ch·ªânh s·ª≠a: ${nameField}`;
            renderEditNhanVienForm(item);
            modal.showModal();
        }

        function closeEditNhanVienModal() {
            const modal = document.getElementById('editNhanVienModal');
            if (modal) modal.close();
            currentEditItem = null;
            editAvatarDataUrl = '';
            editImages = [];
            editFiles = [];
            selectedEditImages = [];
            selectedEditFiles = [];
        }

        function renderEditNhanVienForm(item) {
            const container = document.getElementById('editContent');
            if (!container) return;

            const excludeFields = ["id", "images", "files", "avatarUrl", "avatar", "avatarDataUrl"];
            const allFields = Object.keys(item).filter(key => !excludeFields.includes(key));

            const fieldNameMap = {
                "bo_phan": "B·ªô ph·∫≠n", "vi_tri": "V·ªã tr√≠", "vi_tri_van_don": "V·ªã tr√≠ v·∫≠n ƒë∆°n",
                "ca": "Ca", "chi_nhanh": "Chi nh√°nh", "email": "Email", "ho_va_ten": "H·ªç v√† t√™n",
                "link_van_don": "Link v·∫≠n ƒë∆°n", "mat_khau": "M·∫≠t kh·∫©u", "sƒët": "S·ªë ƒëi·ªán tho·∫°i",
                "sdt": "S·ªë ƒëi·ªán tho·∫°i", "tai_khoan": "T√†i kho·∫£n", "team": "Team", "team_sale_mar": "Team_Sale_Mar"
            };

            // Load existing images and files
            editAvatarDataUrl = item.avatarDataUrl || item.avatarUrl || item.avatar || '';
            editImages = item.images || item.Images || [];
            editFiles = item.files || item.Files || [];
            selectedEditImages = [];
            selectedEditFiles = [];

            const avatarPreview = editAvatarDataUrl ?
                `<img id="editAvatarPreviewImg" src="${escapeHtml(editAvatarDataUrl)}" alt="Avatar" style="width:120px;height:120px;object-fit:cover;border-radius:12px;border:2px solid var(--primary);display:block;" />` :
                '<div id="editAvatarPreviewPlaceholder" style="width:120px;height:120px;border:2px dashed var(--border);border-radius:12px;display:grid;place-items:center;background:#f8fafc;color:var(--text-light);font-size:12px;">Ch∆∞a c√≥ ·∫£nh</div>';

            const existingImagesHtml = editImages.length > 0 ? `
        <div style="margin-top:12px;">
            <div style="font-size:12px;color:var(--text-light);margin-bottom:8px;"><strong>·∫¢nh hi·ªán c√≥ (${editImages.length}):</strong></div>
            <div id="editExistingImages" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;">
                ${editImages.map((img, idx) => {
                const imgUrl = typeof img === "string" ? img : (img.url || img.dataUrl || "");
                return imgUrl ? `
                        <div style="position:relative;">
                            <img src="${escapeHtml(imgUrl)}" alt="Image ${idx + 1}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);" />
                            <button type="button" class="btn" data-remove-img="${idx}" style="position:absolute;top:4px;right:4px;padding:4px 8px;font-size:10px;background:var(--danger);color:#fff;border:none;border-radius:4px;cursor:pointer;">√ó</button>
                        </div>
                    ` : '';
            }).join('')}
            </div>
        </div>
    ` : '';

            const existingFilesHtml = editFiles.length > 0 ? `
        <div style="margin-top:12px;">
            <div style="font-size:12px;color:var(--text-light);margin-bottom:8px;"><strong>File hi·ªán c√≥ (${editFiles.length}):</strong></div>
            <div id="editExistingFiles" style="display:flex;flex-direction:column;gap:6px;">
                ${editFiles.map((file, idx) => {
                const fileName = typeof file === "string" ? `File ${idx + 1}` : (file.name || `File ${idx + 1}`);
                const fileUrl = typeof file === "string" ? file : (file.url || file.dataUrl || "");
                const isImg = fileUrl && (fileUrl.startsWith("data:image") || fileUrl.startsWith("http"));
                return `
                        <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:6px;border:1px solid var(--border);">
                            ${isImg ? `<img src="${escapeHtml(fileUrl)}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;" />` : `<i class="fas fa-file" style="font-size:24px;color:var(--text-light);"></i>`}
                            <span style="flex:1;font-size:13px;word-break:break-word;">${escapeHtml(fileName)}</span>
                            <button type="button" class="btn" data-remove-file="${idx}" style="padding:4px 8px;font-size:10px;background:var(--danger);color:#fff;border:none;border-radius:4px;cursor:pointer;">√ó</button>
                        </div>
                    `;
            }).join('')}
            </div>
        </div>
    ` : '';

            container.innerHTML = `
        <form id="editNhanVienForm" style="display:grid;gap:20px;">
            <!-- ·∫¢nh ƒë·∫°i di·ªán -->
            <div class="field">
                <label style="font-weight:700;font-size:16px;margin-bottom:12px;display:flex;align-items:center;gap:10px;color:var(--primary);">
                    <i class="fas fa-user-circle" style="font-size:20px;"></i> ·∫¢nh ƒë·∫°i di·ªán
                </label>
                <div id="editAvatarPreviewContainer" style="margin-bottom:12px;display:flex;justify-content:center;">
                    ${avatarPreview}
                </div>
                <input type="file" id="editAvatarUpload" accept="image/*" style="margin-bottom:10px;font-size:14px;padding:10px;width:100%;border:2px dashed var(--border);border-radius:8px;cursor:pointer;" />
                <button type="button" class="btn btn-primary" id="btnUploadEditAvatar" style="padding:10px 20px;font-size:14px;width:100%;">
                    <i class="fas fa-upload"></i> Upload ·∫£nh ƒë·∫°i di·ªán
                </button>
            </div>

            <!-- Nhi·ªÅu ·∫£nh -->
            <div class="field" style="border-top:2px solid var(--border);padding-top:24px;">
                <label style="font-weight:700;font-size:16px;margin-bottom:12px;display:flex;align-items:center;gap:10px;color:var(--primary);">
                    <i class="fas fa-images" style="font-size:20px;"></i> Nhi·ªÅu ·∫£nh
                </label>
                ${existingImagesHtml}
                <input type="file" id="editImagesUpload" accept="image/*" multiple style="margin-top:12px;margin-bottom:10px;font-size:14px;padding:10px;width:100%;border:2px dashed var(--border);border-radius:8px;cursor:pointer;" />
                <div style="display:flex;gap:10px;">
                    <button type="button" class="btn btn-secondary" id="btnSelectEditImages" style="padding:10px 20px;font-size:14px;flex:1;">
                        <i class="fas fa-folder-open"></i> Ch·ªçn ·∫£nh
                    </button>
                    <button type="button" class="btn btn-primary" id="btnUploadEditImages" disabled style="padding:10px 20px;font-size:14px;flex:1;">
                        <i class="fas fa-upload"></i> Upload (<span id="editImageCount">0</span>)
                    </button>
                </div>
                <div id="editSelectedImagesPreview" style="margin-top:12px;display:none;">
                    <div style="font-size:13px;color:var(--text-light);margin-bottom:10px;font-weight:600;"><strong>ƒê√£ ch·ªçn:</strong></div>
                    <div id="editSelectedImagesList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;"></div>
                </div>
            </div>

            <!-- Nhi·ªÅu file -->
            <div class="field" style="border-top:2px solid var(--border);padding-top:24px;">
                <label style="font-weight:700;font-size:16px;margin-bottom:12px;display:flex;align-items:center;gap:10px;color:var(--primary);">
                    <i class="fas fa-file-upload" style="font-size:20px;"></i> Nhi·ªÅu file (H·ª£p ƒë·ªìng, CMND, ...)
                </label>
                ${existingFilesHtml}
                <input type="file" id="editFilesUpload" multiple style="margin-top:12px;margin-bottom:10px;font-size:14px;padding:10px;width:100%;border:2px dashed var(--border);border-radius:8px;cursor:pointer;" />
                <div style="display:flex;gap:10px;">
                    <button type="button" class="btn btn-secondary" id="btnSelectEditFiles" style="padding:10px 20px;font-size:14px;flex:1;">
                        <i class="fas fa-folder-open"></i> Ch·ªçn file
                    </button>
                    <button type="button" class="btn btn-primary" id="btnUploadEditFiles" disabled style="padding:10px 20px;font-size:14px;flex:1;">
                        <i class="fas fa-upload"></i> Upload (<span id="editFileCount">0</span>)
                    </button>
                </div>
                <div id="editSelectedFilesPreview" style="margin-top:12px;display:none;">
                    <div style="font-size:13px;color:var(--text-light);margin-bottom:10px;font-weight:600;"><strong>ƒê√£ ch·ªçn:</strong></div>
                    <div id="editSelectedFilesList" style="display:flex;flex-direction:column;gap:8px;"></div>
                </div>
            </div>

            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:20px;border-top:2px solid var(--border);">
                <button type="button" class="btn" onclick="closeEditNhanVienModal()" style="padding:10px 24px;">H·ªßy</button>
                <button type="submit" class="btn btn-primary" style="padding:10px 24px;"><i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi</button>
            </div>
        </form>
    `;

            // Setup event handlers for file uploads
            setupEditFileHandlers(item);

            document.getElementById('editNhanVienForm').addEventListener("submit", async (e) => {
                e.preventDefault();
                await saveEditNhanVien();
            });
        }

        async function saveEditNhanVien() {
            if (!currentEditItem || !currentEditItem.id) {
                showToast("L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n", true);
                return;
            }

            const form = document.getElementById('editNhanVienForm');
            if (!form) return;

            const updates = {};
            let hasChanges = false;

            // Add avatar if changed
            const currentAvatar = currentEditItem.avatarDataUrl || currentEditItem.avatarUrl || currentEditItem.avatar || '';
            if (editAvatarDataUrl && editAvatarDataUrl !== currentAvatar) {
                updates.avatarDataUrl = editAvatarDataUrl;
                hasChanges = true;
            }

            // Add images if changed
            const currentImages = currentEditItem.images || currentEditItem.Images || [];
            if (JSON.stringify(editImages) !== JSON.stringify(currentImages)) {
                updates.images = editImages;
                hasChanges = true;
            }

            // Add files if changed
            const currentFiles = currentEditItem.files || currentEditItem.Files || [];
            if (JSON.stringify(editFiles) !== JSON.stringify(currentFiles)) {
                updates.files = editFiles;
                hasChanges = true;
            }

            if (!hasChanges) {
                showToast("Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë·ªÉ l∆∞u");
                return;
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';
            }

            try {
                await fbUpdate(`employees/${currentEditItem.id}`, updates);
                showToast("ƒê√£ l∆∞u thay ƒë·ªïi th√†nh c√¥ng!");
                closeEditNhanVienModal();
                await syncNhanSu();
            } catch (error) {
                showToast(`L·ªói: ${error.message}`, true);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi';
                }
            }
        }

        // File handling functions
        async function fileToDataUrl(file) {
            return await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error("FileReader failed"));
                reader.onload = () => resolve(String(reader.result || ""));
                reader.readAsDataURL(file);
            });
        }

        async function compressImageToDataUrl(file, opts = {}) {
            const maxW = Number(opts.maxWidth || 1024);
            const maxH = Number(opts.maxHeight || 1024);
            const targetBytes = Number(opts.targetBytes || 380 * 1024);
            const minQuality = Number(opts.minQuality || 0.55);

            const raw = await fileToDataUrl(file);
            const img = await new Promise((resolve, reject) => {
                const i = new Image();
                i.onload = () => resolve(i);
                i.onerror = () => reject(new Error("Image decode failed"));
                i.src = raw;
            });

            const ratio = Math.min(1, maxW / img.width, maxH / img.height);
            const w = Math.max(1, Math.round(img.width * ratio));
            const h = Math.max(1, Math.round(img.height * ratio));
            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext("2d");
            if (!ctx) throw new Error("Canvas not supported");
            ctx.drawImage(img, 0, 0, w, h);

            let q = 0.82;
            let out = canvas.toDataURL("image/jpeg", q);
            while (out.length * 0.75 > targetBytes && q > minQuality) {
                q = Math.max(minQuality, q - 0.08);
                out = canvas.toDataURL("image/jpeg", q);
            }
            return out;
        }

        function setupEditFileHandlers(item) {
            // Avatar upload
            const avatarInput = document.getElementById('editAvatarUpload');
            const btnUploadAvatar = document.getElementById('btnUploadEditAvatar');

            avatarInput?.addEventListener('change', async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                if (!String(file.type || "").startsWith("image/")) {
                    showToast("Vui l√≤ng ch·ªçn file ·∫£nh", true);
                    return;
                }
                try {
                    const dataUrl = await compressImageToDataUrl(file, {
                        maxWidth: 1024,
                        maxHeight: 1024,
                        targetBytes: 380 * 1024,
                        minQuality: 0.55,
                    });
                    editAvatarDataUrl = dataUrl;
                    const preview = document.getElementById('editAvatarPreviewContainer');
                    if (preview) {
                        preview.innerHTML = `<img id="editAvatarPreviewImg" src="${escapeHtml(dataUrl)}" alt="Avatar" style="width:120px;height:120px;object-fit:cover;border-radius:12px;border:2px solid var(--primary);display:block;" />`;
                    }
                    showToast("ƒê√£ ch·ªçn ·∫£nh ƒë·∫°i di·ªán. Nh·∫•n 'L∆∞u thay ƒë·ªïi' ƒë·ªÉ l∆∞u.");
                } catch (error) {
                    showToast(`L·ªói x·ª≠ l√Ω ·∫£nh: ${error.message}`, true);
                }
            });

            btnUploadAvatar?.addEventListener('click', () => {
                avatarInput?.click();
            });

            // Multiple images upload
            const imagesInput = document.getElementById('editImagesUpload');
            const btnSelectImages = document.getElementById('btnSelectEditImages');
            const btnUploadImages = document.getElementById('btnUploadEditImages');

            function updateEditImagesDisplay() {
                const count = selectedEditImages.length;
                const countEl = document.getElementById('editImageCount');
                if (countEl) countEl.textContent = count;
                if (btnUploadImages) btnUploadImages.disabled = count === 0;

                const preview = document.getElementById('editSelectedImagesPreview');
                const list = document.getElementById('editSelectedImagesList');
                if (preview && list) {
                    if (count > 0) {
                        preview.style.display = 'block';
                        list.innerHTML = selectedEditImages.map((file, idx) => {
                            const url = URL.createObjectURL(file);
                            return `
                        <div style="position:relative;">
                            <img src="${url}" alt="Preview" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);" />
                            <button type="button" class="btn" onclick="removeSelectedEditImage(${idx})" style="position:absolute;top:4px;right:4px;padding:4px 8px;font-size:10px;background:var(--danger);color:#fff;border:none;border-radius:4px;cursor:pointer;">√ó</button>
                        </div>
                    `;
                        }).join('');
                    } else {
                        preview.style.display = 'none';
                    }
                }
            }

            window.removeSelectedEditImage = (idx) => {
                selectedEditImages.splice(idx, 1);
                updateEditImagesDisplay();
            };

            imagesInput?.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                selectedEditImages = [...selectedEditImages, ...files];
                updateEditImagesDisplay();
            });

            btnSelectImages?.addEventListener('click', () => {
                imagesInput?.click();
            });

            btnUploadImages?.addEventListener('click', async () => {
                if (selectedEditImages.length === 0) {
                    showToast("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ·∫£nh", true);
                    return;
                }
                try {
                    btnUploadImages.disabled = true;
                    btnUploadImages.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang upload...';

                    const newImages = [];
                    for (let i = 0; i < selectedEditImages.length; i++) {
                        const file = selectedEditImages[i];
                        try {
                            const dataUrl = await compressImageToDataUrl(file, {
                                maxWidth: 1024,
                                maxHeight: 1024,
                                targetBytes: 380 * 1024,
                                minQuality: 0.55,
                            });
                            newImages.push({
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                dataUrl,
                                uploadedAt: Date.now()
                            });
                        } catch (fileError) {
                            console.error(`Error processing image ${file.name}:`, fileError);
                        }
                    }

                    editImages = [...editImages, ...newImages];
                    selectedEditImages = [];
                    updateEditImagesDisplay();

                    // Refresh existing images display
                    const existingContainer = document.getElementById('editExistingImages');
                    if (existingContainer) {
                        existingContainer.innerHTML = editImages.map((img, idx) => {
                            const imgUrl = typeof img === "string" ? img : (img.url || img.dataUrl || "");
                            return imgUrl ? `
                        <div style="position:relative;">
                            <img src="${escapeHtml(imgUrl)}" alt="Image ${idx + 1}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);" />
                            <button type="button" class="btn" onclick="removeEditImage(${idx})" style="position:absolute;top:4px;right:4px;padding:4px 8px;font-size:10px;background:var(--danger);color:#fff;border:none;border-radius:4px;cursor:pointer;">√ó</button>
                        </div>
                    ` : '';
                        }).join('');
                    }

                    showToast(`ƒê√£ upload ${newImages.length} ·∫£nh. Nh·∫•n 'L∆∞u thay ƒë·ªïi' ƒë·ªÉ l∆∞u.`);
                } catch (error) {
                    showToast(`L·ªói upload ·∫£nh: ${error.message}`, true);
                } finally {
                    btnUploadImages.disabled = false;
                    btnUploadImages.innerHTML = `<i class="fas fa-upload"></i> Upload (<span id="editImageCount">${selectedEditImages.length}</span>)`;
                }
            });

            window.removeEditImage = (idx) => {
                editImages.splice(idx, 1);
                const existingContainer = document.getElementById('editExistingImages');
                if (existingContainer) {
                    existingContainer.innerHTML = editImages.map((img, idx) => {
                        const imgUrl = typeof img === "string" ? img : (img.url || img.dataUrl || "");
                        return imgUrl ? `
                    <div style="position:relative;">
                        <img src="${escapeHtml(imgUrl)}" alt="Image ${idx + 1}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);" />
                        <button type="button" class="btn" onclick="removeEditImage(${idx})" style="position:absolute;top:4px;right:4px;padding:4px 8px;font-size:10px;background:var(--danger);color:#fff;border:none;border-radius:4px;cursor:pointer;">√ó</button>
                    </div>
                ` : '';
                    }).join('');
                }
            };

            // Multiple files upload
            const filesInput = document.getElementById('editFilesUpload');
            const btnSelectFiles = document.getElementById('btnSelectEditFiles');
            const btnUploadFiles = document.getElementById('btnUploadEditFiles');

            function updateEditFilesDisplay() {
                const count = selectedEditFiles.length;
                const countEl = document.getElementById('editFileCount');
                if (countEl) countEl.textContent = count;
                if (btnUploadFiles) btnUploadFiles.disabled = count === 0;

                const preview = document.getElementById('editSelectedFilesPreview');
                const list = document.getElementById('editSelectedFilesList');
                if (preview && list) {
                    if (count > 0) {
                        preview.style.display = 'block';
                        list.innerHTML = selectedEditFiles.map((file, idx) => `
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:6px;border:1px solid var(--border);">
                        <i class="fas fa-file" style="font-size:20px;color:var(--text-light);"></i>
                        <span style="flex:1;font-size:13px;word-break:break-word;">${escapeHtml(file.name)}</span>
                        <button type="button" class="btn" onclick="removeSelectedEditFile(${idx})" style="padding:4px 8px;font-size:10px;background:var(--danger);color:#fff;border:none;border-radius:4px;cursor:pointer;">√ó</button>
                    </div>
                `).join('');
                    } else {
                        preview.style.display = 'none';
                    }
                }
            }

            window.removeSelectedEditFile = (idx) => {
                selectedEditFiles.splice(idx, 1);
                updateEditFilesDisplay();
            };

            filesInput?.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                selectedEditFiles = [...selectedEditFiles, ...files];
                updateEditFilesDisplay();
            });

            btnSelectFiles?.addEventListener('click', () => {
                filesInput?.click();
            });

            btnUploadFiles?.addEventListener('click', async () => {
                if (selectedEditFiles.length === 0) {
                    showToast("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file", true);
                    return;
                }
                try {
                    btnUploadFiles.disabled = true;
                    btnUploadFiles.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang upload...';

                    const newFiles = [];
                    for (let i = 0; i < selectedEditFiles.length; i++) {
                        const file = selectedEditFiles[i];
                        try {
                            const dataUrl = await fileToDataUrl(file);
                            newFiles.push({
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                dataUrl,
                                uploadedAt: Date.now()
                            });
                        } catch (fileError) {
                            console.error(`Error processing file ${file.name}:`, fileError);
                        }
                    }

                    editFiles = [...editFiles, ...newFiles];
                    selectedEditFiles = [];
                    updateEditFilesDisplay();

                    // Refresh existing files display
                    const existingContainer = document.getElementById('editExistingFiles');
                    if (existingContainer) {
                        existingContainer.innerHTML = editFiles.map((file, idx) => {
                            const fileName = typeof file === "string" ? `File ${idx + 1}` : (file.name || `File ${idx + 1}`);
                            const fileUrl = typeof file === "string" ? file : (file.url || file.dataUrl || "");
                            const isImg = fileUrl && (fileUrl.startsWith("data:image") || fileUrl.startsWith("http"));
                            return `
                        <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:6px;border:1px solid var(--border);">
                            ${isImg ? `<img src="${escapeHtml(fileUrl)}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;" />` : `<i class="fas fa-file" style="font-size:24px;color:var(--text-light);"></i>`}
                            <span style="flex:1;font-size:13px;word-break:break-word;">${escapeHtml(fileName)}</span>
                            <button type="button" class="btn" onclick="removeEditFile(${idx})" style="padding:4px 8px;font-size:10px;background:var(--danger);color:#fff;border:none;border-radius:4px;cursor:pointer;">√ó</button>
                        </div>
                    `;
                        }).join('');
                    }

                    showToast(`ƒê√£ upload ${newFiles.length} file. Nh·∫•n 'L∆∞u thay ƒë·ªïi' ƒë·ªÉ l∆∞u.`);
                } catch (error) {
                    showToast(`L·ªói upload file: ${error.message}`, true);
                } finally {
                    btnUploadFiles.disabled = false;
                    btnUploadFiles.innerHTML = `<i class="fas fa-upload"></i> Upload (<span id="editFileCount">${selectedEditFiles.length}</span>)`;
                }
            });

            window.removeEditFile = (idx) => {
                editFiles.splice(idx, 1);
                const existingContainer = document.getElementById('editExistingFiles');
                if (existingContainer) {
                    existingContainer.innerHTML = editFiles.map((file, idx) => {
                        const fileName = typeof file === "string" ? `File ${idx + 1}` : (file.name || `File ${idx + 1}`);
                        const fileUrl = typeof file === "string" ? file : (file.url || file.dataUrl || "");
                        const isImg = fileUrl && (fileUrl.startsWith("data:image") || fileUrl.startsWith("http"));
                        return `
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f8fafc;border-radius:6px;border:1px solid var(--border);">
                        ${isImg ? `<img src="${escapeHtml(fileUrl)}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;" />` : `<i class="fas fa-file" style="font-size:24px;color:var(--text-light);"></i>`}
                        <span style="flex:1;font-size:13px;word-break:break-word;">${escapeHtml(fileName)}</span>
                        <button type="button" class="btn" onclick="removeEditFile(${idx})" style="padding:4px 8px;font-size:10px;background:var(--danger);color:#fff;border:none;border-radius:4px;cursor:pointer;">√ó</button>
                    </div>
                `;
                    }).join('');
                }
            };

            // Add event listeners for existing images/files remove buttons
            setTimeout(() => {
                document.querySelectorAll('[data-remove-img]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const idx = Number(btn.getAttribute('data-remove-img'));
                        removeEditImage(idx);
                    });
                });

                document.querySelectorAll('[data-remove-file]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const idx = Number(btn.getAttribute('data-remove-file'));
                        removeEditFile(idx);
                    });
                });
            }, 100);
        }

        // Create Modal
        function openCreateNhanVienModal() {
            const modal = document.getElementById('createNhanVienModal');
            if (!modal) return;
            renderCreateNhanVienForm();
            modal.showModal();
        }

        function renderCreateNhanVienForm() {
            const container = document.getElementById('createContent');
            if (!container) return;

            const commonFields = [
                { key: "ho_va_ten", label: "H·ªç v√† t√™n", required: true },
                { key: "email", label: "Email", required: false },
                { key: "sƒët", label: "S·ªë ƒëi·ªán tho·∫°i", required: false },
                { key: "chi_nhanh", label: "Chi nh√°nh", required: false },
                { key: "bo_phan", label: "B·ªô ph·∫≠n", required: false },
                { key: "vi_tri", label: "V·ªã tr√≠", required: false },
                { key: "team", label: "Team", required: false },
                { key: "team_sale_mar", label: "Team_Sale_Mar", required: false },
                { key: "tai_khoan", label: "T√†i kho·∫£n", required: false },
                { key: "mat_khau", label: "M·∫≠t kh·∫©u", required: false },
                { key: "link_van_don", label: "Link v·∫≠n ƒë∆°n", required: false },
                { key: "vi_tri_van_don", label: "V·ªã tr√≠ v·∫≠n ƒë∆°n", required: false },
                { key: "ca", label: "Ca", required: false }
            ];

            container.innerHTML = `
        <form id="createNhanVienForm" style="display:grid;gap:16px;">
            ${commonFields.map(field => {
                const isLongField = field.key.includes("link");
                return `
                    <div class="field">
                        <label for="create_${escapeHtml(field.key)}">${escapeHtml(field.label)}${field.required ? ' <span style="color:var(--danger);">*</span>' : ''}:</label>
                        ${isLongField ?
                        `<textarea id="create_${escapeHtml(field.key)}" name="${escapeHtml(field.key)}" rows="3"></textarea>` :
                        `<input type="text" id="create_${escapeHtml(field.key)}" name="${escapeHtml(field.key)}" ${field.required ? 'required' : ''} />`
                    }
                    </div>
                `;
            }).join("")}
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;padding-top:20px;border-top:1px solid var(--border);">
                <button type="button" class="btn" onclick="document.getElementById('createNhanVienModal').close()">H·ªßy</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> T·∫°o nh√¢n vi√™n</button>
            </div>
        </form>
    `;

            document.getElementById('createNhanVienForm').addEventListener("submit", async (e) => {
                e.preventDefault();
                await saveNewNhanVien();
            });
        }

        async function saveNewNhanVien() {
            const form = document.getElementById('createNhanVienForm');
            if (!form) return;

            const formData = new FormData(form);
            const newEmployee = {};

            for (const [key, value] of formData.entries()) {
                const trimmedValue = String(value).trim();
                if (trimmedValue) newEmployee[key] = trimmedValue;
            }

            if (!newEmployee.ho_va_ten) {
                showToast("Vui l√≤ng nh·∫≠p H·ªç v√† t√™n!", true);
                return;
            }

            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';
            }

            try {
                const newId = `emp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                newEmployee.id = newId;
                await fbUpdate(`employees/${newId}`, newEmployee);
                showToast("ƒê√£ t·∫°o nh√¢n vi√™n m·ªõi th√†nh c√¥ng!");
                document.getElementById('createNhanVienModal').close();
                form.reset();
                await syncNhanSu();
            } catch (error) {
                showToast(`L·ªói: ${error.message}`, true);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-plus"></i> T·∫°o nh√¢n vi√™n';
                }
            }
        }

        // Event listeners for modals
        document.getElementById('btnCloseDetail')?.addEventListener('click', closeNhanVienDetail);
        document.getElementById('nhanVienDetailModal')?.addEventListener('click', (e) => { if (e.target.id === 'nhanVienDetailModal') closeNhanVienDetail(); });
        document.getElementById('btnCloseEdit')?.addEventListener('click', closeEditNhanVienModal);
        document.getElementById('editNhanVienModal')?.addEventListener('click', (e) => { if (e.target.id === 'editNhanVienModal') closeEditNhanVienModal(); });
        document.getElementById('btnCloseCreate')?.addEventListener('click', () => document.getElementById('createNhanVienModal')?.close());
        document.getElementById('createNhanVienModal')?.addEventListener('click', (e) => { if (e.target.id === 'createNhanVienModal') e.target.close(); });
        document.getElementById('btnCreateNhanVien')?.addEventListener('click', openCreateNhanVienModal);
        document.getElementById('btnRefreshNhanSu')?.addEventListener('click', syncNhanSu);
        // ========== END QTNS NH√ÇN S·ª∞ FUNCTIONS ==========

        // File handling
        function previewAvatar(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    avatarBase64 = e.target.result;
                    document.getElementById('avatar-preview').innerHTML = `<div class="file-item"><img src="${avatarBase64}"><button type="button" class="remove" onclick="removeAvatar()">&times;</button></div>`;
                };
                reader.readAsDataURL(file);
            }
        }
        function removeAvatar() { avatarBase64 = ''; document.getElementById('avatar-preview').innerHTML = ''; }

        function previewFiles(input) {
            const files = input.files;
            filesBase64 = [];
            let html = '';
            Array.from(files).forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = e => {
                    filesBase64.push({ name: file.name, data: e.target.result, type: file.type });
                    const isImg = file.type.startsWith('image/');
                    html += `<div class="file-item" title="${file.name}">${isImg ? `<img src="${e.target.result}">` : `<i class="fas fa-file" style="font-size:2rem;margin:20px auto;display:block;color:#666"></i>`}<button type="button" class="remove" onclick="removeFile(${i})">&times;</button></div>`;
                    document.getElementById('files-preview').innerHTML = html;
                };
                reader.readAsDataURL(file);
            });
        }
        function removeFile(idx) {
            filesBase64.splice(idx, 1);
            const items = document.querySelectorAll('#files-preview .file-item');
            items[idx]?.remove();
        }

        // Format currency
        function formatMoney(n) {
            try {
                if (n === null || n === undefined || isNaN(n)) return '0 ƒë';
                return new Intl.NumberFormat('vi-VN').format(Number(n)) + ' ƒë';
            } catch (e) {
                return String(n || 0) + ' ƒë';
            }
        }

        // ========== RECRUITMENT FUNCTIONS ==========
        async function loadRecruitmentData() {
            try {
                const data = await fbGet('hr/recruitment');
                dinhBiens = data?.dinhBiens ? Object.entries(data.dinhBiens).map(([k, v]) => ({ ...v, id: k })) : [];
                cvList = data?.cvList ? Object.entries(data.cvList).map(([k, v]) => ({ ...v, id: k })) : [];
                renderDinhBien();
                renderCVList();
            } catch (e) { console.error(e); }
        }

        function renderDinhBien() {
            const tbody = document.getElementById('dinh-bien-list');
            if (!tbody) return;
            tbody.innerHTML = dinhBiens.length ? dinhBiens.map((d, i) => {
                const canTuyen = Math.max(0, (d.target || 0) - (d.current || 0));
                return `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(d.department || '-')}</td>
            <td>${escapeHtml(d.position || '-')}</td>
            <td>${d.current || 0}</td>
            <td>${d.target || 0}</td>
            <td style="font-weight:700;color:${canTuyen > 0 ? 'var(--danger)' : 'var(--success)'};">${canTuyen}</td>
            <td>${escapeHtml(d.note || '-')}</td>
            <td class="actions"><button class="edit" onclick="editDinhBien('${d.id}')"><i class="fas fa-edit"></i></button><button class="delete" onclick="deleteDinhBien('${d.id}')"><i class="fas fa-trash"></i></button></td>
        </tr>`;
            }).join('') : '<tr><td colspan="8" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªãnh bi√™n</td></tr>';
        }

        function renderCVList() {
            const tbody = document.getElementById('cv-list');
            if (!tbody) return;
            tbody.innerHTML = cvList.length ? cvList.map((cv, i) => {
                const statusClass = cv.status === 'CV tr√∫ng tuy·ªÉn' ? 'badge-success' : cv.status === 'CV kh√¥ng ph√π h·ª£p' ? 'badge-danger' : 'badge-warning';
                return `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(cv.name || '-')}</td>
            <td>${escapeHtml(cv.phone || '-')}</td>
            <td>${escapeHtml(cv.email || '-')}</td>
            <td>${escapeHtml(cv.position || '-')}</td>
            <td>${escapeHtml(cv.department || '-')}</td>
            <td>${escapeHtml(cv.source || '-')}</td>
            <td><span class="badge ${statusClass}">${escapeHtml(cv.status || '-')}</span></td>
            <td>${cv.date || '-'}</td>
            <td class="actions">
                <button class="view" onclick="viewCV('${cv.id}')"><i class="fas fa-eye"></i></button>
                <button class="edit" onclick="editCV('${cv.id}')"><i class="fas fa-edit"></i></button>
                ${cv.status === 'CV tr√∫ng tuy·ªÉn' ? `<button class="btn btn-success btn-sm" onclick="convertToEmployee('${cv.id}')" style="font-size:10px;padding:4px 8px;">+ NV</button>` : ''}
                <button class="delete" onclick="deleteCV('${cv.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
            }).join('') : '<tr><td colspan="10" class="empty-state">Ch∆∞a c√≥ CV ·ª©ng vi√™n</td></tr>';
        }

        function openDinhBienModal() { openModal('dinhBienModal'); }
        function openCVModal() { openModal('cvModal'); }

        async function convertToEmployee(cvId) {
            const cv = cvList.find(c => c.id === cvId);
            if (!cv) return;
            if (!confirm(`Chuy·ªÉn "${cv.name}" th√†nh nh√¢n vi√™n th·ª≠ vi·ªác?`)) return;
            const newId = `emp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const newEmp = {
                id: newId,
                ho_va_ten: cv.name,
                email: cv.email || '',
                sƒët: cv.phone || '',
                bo_phan: cv.department || '',
                vi_tri: cv.position || '',
                trang_thai: 'Th·ª≠ vi·ªác',
                ngay_vao_lam: new Date().toISOString().split('T')[0]
            };
            try {
                await fbUpdate(`employees/${newId}`, newEmp);
                await fbUpdate(`hr/recruitment/cvList/${cvId}`, { status: 'ƒê√£ chuy·ªÉn NV' });
                showToast(`ƒê√£ chuy·ªÉn ${cv.name} th√†nh nh√¢n vi√™n th·ª≠ vi·ªác!`);
                loadRecruitmentData();
                syncNhanSu();
            } catch (e) { showToast(`L·ªói: ${e.message}`, true); }
        }

        // ========== STATUS HISTORY FUNCTIONS ==========
        async function loadStatusHistory() {
            try {
                const data = await fbGet('hr/statusHistory');
                statusHistory = data ? Object.entries(data).map(([k, v]) => ({ ...v, id: k })) : [];
                renderStatusHistory();
                updateStatusStats();
            } catch (e) { console.error(e); }
        }

        function renderStatusHistory() {
            const tbody = document.getElementById('status-history-list');
            if (!tbody) return;
            tbody.innerHTML = statusHistory.length ? statusHistory.map((h, i) => `<tr>
        <td>${i + 1}</td>
        <td>${escapeHtml(h.employeeCode || '-')}</td>
        <td>${escapeHtml(h.employeeName || '-')}</td>
        <td>${escapeHtml(h.oldStatus || '-')}</td>
        <td><span class="badge status-${(h.newStatus || '').toLowerCase().replace(/\s/g, '-')}">${escapeHtml(h.newStatus || '-')}</span></td>
        <td>${h.effectiveDate || '-'}</td>
        <td>${escapeHtml(h.performer || '-')}</td>
        <td>${escapeHtml(h.note || '-')}</td>
    </tr>`).join('') : '<tr><td colspan="8" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu bi·∫øn ƒë·ªông</td></tr>';
        }

        function updateStatusStats() {
            const thuViec = statusHistory.filter(h => h.newStatus === 'Th·ª≠ vi·ªác').length;
            const chinhThuc = statusHistory.filter(h => h.newStatus === 'Ch√≠nh th·ª©c').length;
            const nghiViec = statusHistory.filter(h => h.newStatus === 'Ngh·ªâ vi·ªác').length;
            document.getElementById('stat-thu-viec').textContent = thuViec;
            document.getElementById('stat-chinh-thuc').textContent = chinhThuc;
            document.getElementById('stat-nghi-viec').textContent = nghiViec;
        }

        function filterStatusHistory() {
            const from = document.getElementById('status-from-date').value;
            const to = document.getElementById('status-to-date').value;
            const filtered = statusHistory.filter(h => {
                if (!from && !to) return true;
                const date = h.effectiveDate;
                if (from && date < from) return false;
                if (to && date > to) return false;
                return true;
            });
            const tbody = document.getElementById('status-history-list');
            tbody.innerHTML = filtered.length ? filtered.map((h, i) => `<tr>
        <td>${i + 1}</td>
        <td>${escapeHtml(h.employeeCode || '-')}</td>
        <td>${escapeHtml(h.employeeName || '-')}</td>
        <td>${escapeHtml(h.oldStatus || '-')}</td>
        <td><span class="badge status-${(h.newStatus || '').toLowerCase().replace(/\s/g, '-')}">${escapeHtml(h.newStatus || '-')}</span></td>
        <td>${h.effectiveDate || '-'}</td>
        <td>${escapeHtml(h.performer || '-')}</td>
        <td>${escapeHtml(h.note || '-')}</td>
    </tr>`).join('') : '<tr><td colspan="8" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y</td></tr>';
        }

        // ========== BHXH FUNCTIONS ==========
        async function loadBHXH() {
            try {
                const data = await fbGet('hr/bhxh');
                bhxhList = data ? Object.entries(data).map(([k, v]) => ({ ...v, id: k })) : [];
                renderBHXH();
            } catch (e) { console.error(e); }
        }

        function renderBHXH() {
            const tbody = document.getElementById('bhxh-list');
            if (!tbody) return;
            tbody.innerHTML = bhxhList.length ? bhxhList.map((b, i) => {
                const emp = nhanSuData.find(e => e.id === b.employeeId);
                return `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(b.employeeId?.substring(0, 8) || '-')}</td>
            <td>${escapeHtml(emp?.ho_va_ten || emp?.name || '-')}</td>
            <td>${escapeHtml(emp?.bo_phan || '-')}</td>
            <td>${escapeHtml(b.bhxhNumber || '-')}</td>
            <td>${b.joinDate || '-'}</td>
            <td>${formatMoney(b.salary || 0)}</td>
            <td>${b.rateEmployee || 10.5}%</td>
            <td>${b.rateCompany || 21.5}%</td>
            <td><span class="badge ${b.status === 'ƒêang tham gia' ? 'badge-success' : 'badge-danger'}">${escapeHtml(b.status || '-')}</span></td>
            <td class="actions"><button class="view" onclick="viewBHXH('${b.id}')"><i class="fas fa-eye"></i></button><button class="edit" onclick="editBHXH('${b.id}')"><i class="fas fa-edit"></i></button></td>
        </tr>`;
            }).join('') : '<tr><td colspan="11" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu BHXH</td></tr>';
        }

        function openBHXHModal() {
            populateBHXHEmployees();
            openModal('bhxhModal');
        }

        function populateBHXHEmployees() {
            const select = document.getElementById('bhxh-employee');
            if (select) {
                select.innerHTML = '<option value="">Ch·ªçn nh√¢n vi√™n</option>' + nhanSuData.map(e => `<option value="${e.id}">${escapeHtml(e.ho_va_ten || e.name || 'N/A')}</option>`).join('');
            }
        }

        // ========== TAX FUNCTIONS ==========
        async function loadTax() {
            try {
                const data = await fbGet('hr/tax');
                taxList = data?.info ? Object.entries(data.info).map(([k, v]) => ({ ...v, id: k })) : [];
                dependents = data?.dependents ? Object.entries(data.dependents).map(([k, v]) => ({ ...v, id: k })) : [];
                renderTax();
                renderDependents();
            } catch (e) { console.error(e); }
        }

        function renderTax() {
            const tbody = document.getElementById('tax-list');
            if (!tbody) return;
            tbody.innerHTML = taxList.length ? taxList.map((t, i) => {
                const emp = nhanSuData.find(e => e.id === t.employeeId);
                const empDeps = dependents.filter(d => d.employeeId === t.employeeId && d.status === 'ƒêang √°p d·ª•ng');
                const depDeduction = empDeps.length * 4400000;
                const taxableIncome = Math.max(0, (t.income || 0) - (t.personalDeduction || 11000000) - depDeduction - (t.bhxhDeduction || 0));
                const tax = calculateTax(taxableIncome, t.taxType || 'L≈©y ti·∫øn');
                return `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(t.employeeId?.substring(0, 8) || '-')}</td>
            <td>${escapeHtml(emp?.ho_va_ten || emp?.name || '-')}</td>
            <td>${escapeHtml(t.taxCode || '-')}</td>
            <td>${formatMoney(t.income || 0)}</td>
            <td>${formatMoney(t.personalDeduction || 11000000)}</td>
            <td>${formatMoney(depDeduction)}</td>
            <td>${formatMoney(taxableIncome)}</td>
            <td>${escapeHtml(t.taxType || 'L≈©y ti·∫øn')}</td>
            <td style="font-weight:700;color:var(--danger);">${formatMoney(tax)}</td>
            <td>${t.period || '-'}</td>
            <td class="actions"><button class="view" onclick="viewTax('${t.id}')"><i class="fas fa-eye"></i></button><button class="edit" onclick="editTax('${t.id}')"><i class="fas fa-edit"></i></button></td>
        </tr>`;
            }).join('') : '<tr><td colspan="12" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu thu·∫ø TNCN</td></tr>';
        }

        function calculateTax(income, type) {
            if (type === 'To√†n ph·∫ßn') return income * 0.1;
            // L≈©y ti·∫øn
            if (income <= 5000000) return income * 0.05;
            if (income <= 10000000) return income * 0.1 - 250000;
            if (income <= 18000000) return income * 0.15 - 750000;
            if (income <= 32000000) return income * 0.2 - 1650000;
            if (income <= 52000000) return income * 0.25 - 3250000;
            if (income <= 80000000) return income * 0.3 - 5850000;
            return income * 0.35 - 9850000;
        }

        function renderDependents() {
            const tbody = document.getElementById('dependent-list');
            if (!tbody) return;
            tbody.innerHTML = dependents.length ? dependents.map((d, i) => {
                const emp = nhanSuData.find(e => e.id === d.employeeId);
                return `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(d.employeeId?.substring(0, 8) || '-')}</td>
            <td>${escapeHtml(emp?.ho_va_ten || emp?.name || '-')}</td>
            <td>${escapeHtml(d.name || '-')}</td>
            <td>${escapeHtml(d.relation || '-')}</td>
            <td>${d.dob || '-'}</td>
            <td>${escapeHtml(d.cccd || '-')}</td>
            <td>${d.fromDate || '-'}</td>
            <td>${d.toDate || '-'}</td>
            <td><span class="badge ${d.status === 'ƒêang √°p d·ª•ng' ? 'badge-success' : 'badge-danger'}">${escapeHtml(d.status || '-')}</span></td>
            <td class="actions"><button class="edit" onclick="editDependent('${d.id}')"><i class="fas fa-edit"></i></button><button class="delete" onclick="deleteDependent('${d.id}')"><i class="fas fa-trash"></i></button></td>
        </tr>`;
            }).join('') : '<tr><td colspan="11" class="empty-state">Ch∆∞a c√≥ ng∆∞·ªùi ph·ª• thu·ªôc</td></tr>';
        }

        function openTaxModal() {
            populateTaxEmployees();
            openModal('taxModal');
        }

        function openDependentModal() {
            populateDependentEmployees();
            openModal('dependentModal');
        }

        function populateTaxEmployees() {
            const select = document.getElementById('tax-employee');
            if (select) {
                select.innerHTML = '<option value="">Ch·ªçn nh√¢n vi√™n</option>' + nhanSuData.map(e => `<option value="${e.id}">${escapeHtml(e.ho_va_ten || e.name || 'N/A')}</option>`).join('');
            }
        }

        function populateDependentEmployees() {
            const select = document.getElementById('dependent-employee');
            if (select) {
                select.innerHTML = '<option value="">Ch·ªçn nh√¢n vi√™n</option>' + nhanSuData.map(e => `<option value="${e.id}">${escapeHtml(e.ho_va_ten || e.name || 'N/A')}</option>`).join('');
            }
        }

        // ========== PAYSLIP FUNCTIONS ==========
        function populatePayslipEmployees() {
            const select = document.getElementById('payslip-employee');
            if (select) {
                select.innerHTML = '<option value="">Ch·ªçn nh√¢n vi√™n</option>' + nhanSuData.map(e => `<option value="${e.id}">${escapeHtml(e.ho_va_ten || e.name || 'N/A')}</option>`).join('');
            }
        }

        function viewPayslip() {
            const empId = document.getElementById('payslip-employee').value;
            const period = document.getElementById('payslip-month').value;
            if (!empId) { showToast('Vui l√≤ng ch·ªçn nh√¢n vi√™n', true); return; }

            const emp = nhanSuData.find(e => e.id === empId);
            if (!emp) return;

            const baseSalary = 12000000;
            const p3Result = 110;
            const salary3P = baseSalary * (p3Result / 100);
            const bonus = 2000000;
            const totalIncome = salary3P + bonus;
            const bhxhDeduction = 800000;
            const taxDeduction = 700000;
            const totalDeduction = bhxhDeduction + taxDeduction;
            const netSalary = totalIncome - totalDeduction;

            const content = document.getElementById('payslip-content');
            content.style.display = 'block';
            content.innerHTML = `
        <div class="payslip-container">
            <div class="payslip-header">
                <h2>PHI·∫æU L∆Ø∆†NG</h2>
                <p>K·ª≥ l∆∞∆°ng: ${period}</p>
            </div>
            <div class="payslip-body">
                <div class="payslip-section">
                    <h4><i class="fas fa-user"></i> 1. Th√¥ng tin chung</h4>
                    <div class="payslip-row"><span>H·ªç t√™n:</span><strong>${escapeHtml(emp.ho_va_ten || emp.name || '-')}</strong></div>
                    <div class="payslip-row"><span>M√£ nh√¢n s·ª±:</span><span>${escapeHtml(empId.substring(0, 12))}</span></div>
                    <div class="payslip-row"><span>B·ªô ph·∫≠n:</span><span>${escapeHtml(emp.bo_phan || '-')}</span></div>
                    <div class="payslip-row"><span>V·ªã tr√≠:</span><span>${escapeHtml(emp.vi_tri || '-')}</span></div>
                </div>
                <div class="payslip-section">
                    <h4><i class="fas fa-plus-circle" style="color:var(--success);"></i> 2. Thu nh·∫≠p</h4>
                    <div class="payslip-row"><span>L∆∞∆°ng b·∫≠c P1:</span><span>${formatMoney(baseSalary)}</span></div>
                    <div class="payslip-row"><span>K·∫øt qu·∫£ P3 (KPI):</span><span>${p3Result}%</span></div>
                    <div class="payslip-row highlight"><span>L∆∞∆°ng 3P:</span><strong>${formatMoney(salary3P)}</strong></div>
                    <div class="payslip-row"><span>Th∆∞·ªüng n√≥ng:</span><span>${formatMoney(bonus)}</span></div>
                    <div class="payslip-row highlight"><span>T·ªïng thu nh·∫≠p:</span><strong style="color:var(--success);">${formatMoney(totalIncome)}</strong></div>
                </div>
                <div class="payslip-section">
                    <h4><i class="fas fa-minus-circle" style="color:var(--danger);"></i> 3. Kh·∫•u tr·ª´</h4>
                    <div class="payslip-row"><span>BHXH (10.5%):</span><span>${formatMoney(bhxhDeduction)}</span></div>
                    <div class="payslip-row"><span>Thu·∫ø TNCN:</span><span>${formatMoney(taxDeduction)}</span></div>
                    <div class="payslip-row highlight"><span>T·ªïng kh·∫•u tr·ª´:</span><strong style="color:var(--danger);">${formatMoney(totalDeduction)}</strong></div>
                </div>
                <div class="payslip-row total"><span>4. TH·ª∞C Lƒ®NH:</span><strong>${formatMoney(netSalary)}</strong></div>
            </div>
        </div>
    `;
        }

        function printPayslip() {
            const content = document.getElementById('payslip-content');
            if (!content.innerHTML) { showToast('Vui l√≤ng xem phi·∫øu l∆∞∆°ng tr∆∞·ªõc', true); return; }
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Phi·∫øu l∆∞∆°ng</title><style>body{font-family:Arial,sans-serif;padding:20px}.payslip-container{max-width:800px;margin:0 auto;border:2px solid #333}.payslip-header{background:#00b14f;color:#fff;padding:25px;text-align:center}.payslip-header h2{margin:0}.payslip-body{padding:25px}.payslip-section{margin-bottom:25px}.payslip-section h4{border-bottom:2px solid #00b14f;padding-bottom:8px;margin-bottom:15px}.payslip-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}.payslip-row.highlight{background:#f0f0f0;padding:10px;margin:0 -25px;padding-left:25px;padding-right:25px}.payslip-row.total{background:#d4edda;margin:10px -25px 0;padding:15px 25px;font-size:1.2rem}</style></head><body>');
            printWindow.document.write(content.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function exportPayroll() { showToast('T√≠nh nƒÉng xu·∫•t Excel ƒëang ph√°t tri·ªÉn'); }

        // ========== MISSING FUNCTION STUBS ==========
        function openUploadExcel() { showToast('T√≠nh nƒÉng import Excel ƒëang ph√°t tri·ªÉn'); }

        function openEmployeeSalaryModal() { showToast('T√≠nh nƒÉng g√°n b·∫≠c l∆∞∆°ng NV ƒëang ph√°t tri·ªÉn'); }

        function openKPIConversionModal() { showToast('T√≠nh nƒÉng t·ª∑ l·ªá quy ƒë·ªïi KPI ƒëang ph√°t tri·ªÉn'); }

        function openTrainingParticipantModal() { showToast('T√≠nh nƒÉng g√°n h·ªçc vi√™n ƒëang ph√°t tri·ªÉn'); }

        function filterCV() {
            const status = document.getElementById('filter-cv-status')?.value || '';
            const position = document.getElementById('filter-cv-position')?.value || '';
            const filtered = cvList.filter(cv => {
                if (status && cv.status !== status) return false;
                if (position && cv.position !== position) return false;
                return true;
            });
            const tbody = document.getElementById('cv-list');
            if (tbody) {
                tbody.innerHTML = filtered.length ? filtered.map((cv, i) => {
                    const statusClass = cv.status === 'CV tr√∫ng tuy·ªÉn' ? 'badge-success' : cv.status === 'CV kh√¥ng ph√π h·ª£p' ? 'badge-danger' : 'badge-warning';
                    return `<tr>
                <td>${i + 1}</td>
                <td>${escapeHtml(cv.name || '-')}</td>
                <td>${escapeHtml(cv.phone || '-')}</td>
                <td>${escapeHtml(cv.email || '-')}</td>
                <td>${escapeHtml(cv.position || '-')}</td>
                <td>${escapeHtml(cv.department || '-')}</td>
                <td>${escapeHtml(cv.source || '-')}</td>
                <td><span class="badge ${statusClass}">${escapeHtml(cv.status || '-')}</span></td>
                <td>${cv.date || '-'}</td>
                <td class="actions">
                    <button class="view" onclick="viewCV('${cv.id}')"><i class="fas fa-eye"></i></button>
                    <button class="edit" onclick="editCV('${cv.id}')"><i class="fas fa-edit"></i></button>
                    ${cv.status === 'CV tr√∫ng tuy·ªÉn' ? `<button class="btn btn-success btn-sm" onclick="convertToEmployee('${cv.id}')" style="font-size:10px;padding:4px 8px;">+ NV</button>` : ''}
                    <button class="delete" onclick="deleteCV('${cv.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
                }).join('') : '<tr><td colspan="10" class="empty-state">Kh√¥ng c√≥ CV ph√π h·ª£p</td></tr>';
            }
        }

        function filterCompetencyFramework() { showToast('T√≠nh nƒÉng l·ªçc khung nƒÉng l·ª±c ƒëang ph√°t tri·ªÉn'); }

        function filterTrainingParticipants() { showToast('T√≠nh nƒÉng l·ªçc h·ªçc vi√™n ƒëang ph√°t tri·ªÉn'); }

        function editDinhBien(id) {
            const d = dinhBiens.find(x => x.id === id);
            if (!d) return;
            document.getElementById('dinh-bien-id').value = d.id;
            document.getElementById('dinh-bien-dept').value = d.department || '';
            document.getElementById('dinh-bien-position').value = d.position || '';
            document.getElementById('dinh-bien-current').value = d.current || 0;
            document.getElementById('dinh-bien-target').value = d.target || 0;
            document.getElementById('dinh-bien-note').value = d.note || '';
            openModal('dinhBienModal');
        }

        function editCV(id) {
            const cv = cvList.find(x => x.id === id);
            if (!cv) return;
            document.getElementById('cv-id').value = cv.id;
            document.getElementById('cv-name').value = cv.name || '';
            document.getElementById('cv-phone').value = cv.phone || '';
            document.getElementById('cv-email').value = cv.email || '';
            document.getElementById('cv-source').value = cv.source || 'Facebook';
            document.getElementById('cv-position').value = cv.position || '';
            document.getElementById('cv-dept').value = cv.department || '';
            document.getElementById('cv-status').value = cv.status || 'CV ti·∫øp nh·∫≠n';
            document.getElementById('cv-date').value = cv.date || '';
            document.getElementById('cv-note').value = cv.note || '';
            openModal('cvModal');
        }

        function viewCV(id) {
            const cv = cvList.find(x => x.id === id);
            if (!cv) return;
            alert(`CV: ${cv.name}\nSƒêT: ${cv.phone}\nEmail: ${cv.email}\nV·ªã tr√≠: ${cv.position}\nTr·∫°ng th√°i: ${cv.status}`);
        }

        function editKPICatalog(id) {
            const k = kpiCatalog.find(x => x.id === id);
            if (!k) return;
            document.getElementById('kpi-catalog-id').value = k.id;
            document.getElementById('kpi-code').value = k.code || '';
            document.getElementById('kpi-catalog-name').value = k.name || '';
            document.getElementById('kpi-unit').value = k.unit || '';
            document.getElementById('kpi-target-group').value = k.targetGroup || 'C√° nh√¢n MKT';
            document.getElementById('kpi-weight').value = k.weight || 50;
            document.getElementById('kpi-apply-month').value = k.applyMonth || '';
            document.getElementById('kpi-catalog-status').value = k.status || 'ƒêang √°p d·ª•ng';
            openModal('kpiCatalogModal');
        }

        function viewBHXH(id) {
            const b = bhxhList.find(x => x.id === id);
            if (!b) return;
            alert(`BHXH: ${b.bhxhNumber}\nNg√†y tham gia: ${b.joinDate}\nM·ª©c l∆∞∆°ng ƒë√≥ng: ${formatMoney(b.salary || 0)}`);
        }

        function editBHXH(id) {
            const b = bhxhList.find(x => x.id === id);
            if (!b) return;
            document.getElementById('bhxh-id').value = b.id;
            document.getElementById('bhxh-employee').value = b.employeeId || '';
            document.getElementById('bhxh-number').value = b.bhxhNumber || '';
            document.getElementById('bhxh-join-date').value = b.joinDate || '';
            document.getElementById('bhxh-salary').value = b.salary || 0;
            document.getElementById('bhxh-status').value = b.status || 'ƒêang tham gia';
            document.getElementById('bhxh-rate-employee').value = b.rateEmployee || 10.5;
            document.getElementById('bhxh-rate-company').value = b.rateCompany || 21.5;
            populateBHXHEmployees();
            openModal('bhxhModal');
        }

        function viewTax(id) {
            const t = taxList.find(x => x.id === id);
            if (!t) return;
            alert(`MST: ${t.taxCode || '-'}\nBi·ªÉu thu·∫ø: ${t.taxType || '-'}\nK·ª≥: ${t.period || '-'}`);
        }

        function editTax(id) {
            const t = taxList.find(x => x.id === id);
            if (!t) return;
            document.getElementById('tax-id').value = t.id;
            document.getElementById('tax-employee').value = t.employeeId || '';
            document.getElementById('tax-code').value = t.taxCode || '';
            document.getElementById('tax-type').value = t.taxType || 'L≈©y ti·∫øn';
            document.getElementById('tax-personal-deduction').value = t.personalDeduction || 11000000;
            document.getElementById('tax-period').value = t.period || '';
            populateTaxEmployees();
            openModal('taxModal');
        }

        function editDependent(id) {
            const d = dependents.find(x => x.id === id);
            if (!d) return;
            document.getElementById('dependent-id').value = d.id;
            document.getElementById('dependent-employee').value = d.employeeId || '';
            document.getElementById('dependent-name').value = d.name || '';
            document.getElementById('dependent-relation').value = d.relation || 'Con';
            document.getElementById('dependent-dob').value = d.dob || '';
            document.getElementById('dependent-cccd').value = d.cccd || '';
            document.getElementById('dependent-from').value = d.fromDate || '';
            document.getElementById('dependent-to').value = d.toDate || '';
            document.getElementById('dependent-status').value = d.status || 'ƒêang √°p d·ª•ng';
            populateDependentEmployees();
            openModal('dependentModal');
        }

        // Load all data
        async function loadData() {
            try {
                // Load employees from separate path (QTNS style)
                const empData = await fbGet('employees');
                if (empData === null || empData === undefined) {
                    employees = [];
                    nhanSuData = [];
                } else if (Array.isArray(empData)) {
                    employees = empData.filter(item => item !== null && item !== undefined);
                    nhanSuData = employees;
                } else if (typeof empData === "object") {
                    employees = Object.entries(empData)
                        .filter(([k, v]) => v !== null && v !== undefined)
                        .map(([k, v]) => ({ ...v, id: k }));
                    nhanSuData = employees;
                } else {
                    employees = [];
                    nhanSuData = [];
                }

                console.log('Loaded employees:', nhanSuData.length);

                // Try to load other data, but don't fail if it doesn't exist
                try {
                    const data = await fbGet('hr');
                    salaryGrades = data?.salaryGrades ? Object.entries(data.salaryGrades).map(([k, v]) => ({ ...v, id: k })) : [];
                    trainings = data?.trainings ? Object.entries(data.trainings).map(([k, v]) => ({ ...v, id: k })) : [];
                    evaluations = data?.evaluations ? Object.entries(data.evaluations).map(([k, v]) => ({ ...v, id: k })) : [];
                    kpis = data?.kpis ? Object.entries(data.kpis).map(([k, v]) => ({ ...v, id: k })) : [];
                    tasks = data?.tasks ? Object.entries(data.tasks).map(([k, v]) => ({ ...v, id: k })) : [];
                    attendances = data?.attendances ? Object.entries(data.attendances).map(([k, v]) => ({ ...v, id: k })) : [];
                } catch (hrError) {
                    console.warn('HR data not found, using empty arrays:', hrError);
                    salaryGrades = [];
                    trainings = [];
                    evaluations = [];
                    kpis = [];
                    tasks = [];
                    attendances = [];
                }

                renderAll();
                // Force update dashboard after a short delay to ensure DOM is ready
                setTimeout(() => {
                    renderDashboard();
                }, 200);
            } catch (e) {
                console.error('Error loading data:', e);
                employees = [];
                nhanSuData = [];
                showToast('L·ªói t·∫£i d·ªØ li·ªáu: ' + (e.message || 'Unknown error'), true);
                // Still try to render with empty data
                renderAll();
                setTimeout(() => {
                    renderDashboard();
                }, 200);
            }
        }

        function renderAll() {
            try {
                // Ensure nhanSuData is always an array
                if (!Array.isArray(nhanSuData)) {
                    nhanSuData = [];
                }
                if (!Array.isArray(employees)) {
                    employees = [];
                }
                if (!Array.isArray(salaryGrades)) {
                    salaryGrades = [];
                }
                if (!Array.isArray(trainings)) {
                    trainings = [];
                }
                if (!Array.isArray(evaluations)) {
                    evaluations = [];
                }
                if (!Array.isArray(kpis)) {
                    kpis = [];
                }
                if (!Array.isArray(tasks)) {
                    tasks = [];
                }
                if (!Array.isArray(attendances)) {
                    attendances = [];
                }

                if (document.getElementById('total-employees')) renderDashboard();
                if (document.getElementById('nhanSuTableContainer')) renderNhanSuTable(nhanSuData); // QTNS style employees
                if (document.getElementById('salary-grades')) renderSalaryGrades();
                if (document.getElementById('training-list')) renderTrainings();
                if (document.getElementById('evaluation-list')) renderEvaluations();
                if (document.getElementById('kpi-list')) renderKPIs();
                if (document.getElementById('task-list')) renderTasks();
                if (document.getElementById('attendance-list')) renderAttendance();
                populateEmployeeSelects();
            } catch (e) {
                console.error('Error in renderAll:', e);
                showToast('L·ªói khi render d·ªØ li·ªáu: ' + (e.message || 'Unknown error'), true);
            }
        }

        function renderDashboard() {
            try {
                // Ensure nhanSuData is an array
                if (!Array.isArray(nhanSuData)) {
                    nhanSuData = [];
                }
                if (!Array.isArray(tasks)) {
                    tasks = [];
                }

                const totalEmp = document.getElementById('total-employees');
                const totalSg = document.getElementById('total-sg');
                const totalHn = document.getElementById('total-hn');
                const totalTasks = document.getElementById('total-tasks');
                const recentEmp = document.getElementById('recent-employees');

                const totalCount = nhanSuData.length;
                const hcmCount = nhanSuData.filter(e => {
                    const branch = e.chi_nhanh || e.branch || '';
                    return branch === 'HCM' || branch === 'H·ªì Ch√≠ Minh' || branch === 'TP. H·ªì Ch√≠ Minh';
                }).length;
                const hanoiCount = nhanSuData.filter(e => {
                    const branch = e.chi_nhanh || e.branch || '';
                    return branch === 'H√† N·ªôi' || branch === 'Hanoi' || branch === 'HN';
                }).length;
                const tasksCount = tasks.filter(t => t.status === 'ƒêang l√†m').length;

                if (totalEmp) {
                    totalEmp.textContent = totalCount;
                    console.log('Dashboard - Total employees:', totalCount);
                }
                if (totalSg) {
                    totalSg.textContent = hcmCount;
                    console.log('Dashboard - HCM count:', hcmCount);
                }
                if (totalHn) {
                    totalHn.textContent = hanoiCount;
                    console.log('Dashboard - Hanoi count:', hanoiCount);
                }
                if (totalTasks) totalTasks.textContent = tasksCount;

                if (recentEmp) {
                    const recent = nhanSuData.slice(-5).reverse();
                    recentEmp.innerHTML = recent.length ? recent.map(e => {
                        const name = e.ho_va_ten || e.name || e.T√™n || 'N/A';
                        const position = e.vi_tri || e.position || '-';
                        const branch = e.chi_nhanh || e.branch || '-';
                        const avatar = e.avatarDataUrl || e.avatarUrl || e.avatar || '';
                        return `
                <tr>
                    <td>${avatar ? `<img class="avatar" src="${escapeHtml(avatar)}" onerror="this.style.display='none'">` : '<span class="avatar" style="background:var(--primary);display:inline-block;"></span>'}</td>
                    <td>${escapeHtml(name)}</td>
                    <td>${escapeHtml(position)}</td>
                    <td><span class="badge ${branch === 'H√† N·ªôi' ? 'badge-hn' : 'badge-sg'}">${escapeHtml(branch)}</span></td>
                    <td>-</td>
                </tr>
            `}).join('') : '<tr><td colspan="5" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                }
            } catch (e) {
                console.error('Error in renderDashboard:', e);
            }
        }

        // Old renderEmployees - replaced by QTNS-style renderNhanSuTable
        // function renderEmployees() { ... }
        // function filterEmployees() { ... }

        // Old employee functions - replaced by QTNS-style openNhanVienDetail, openEditNhanVienModal, etc.
        // viewEmployee, editEmployee, deleteEmployee functions moved to QTNS section above

        // Salary Grades
        function renderSalaryGrades() {
            try {
                const tbody = document.getElementById('salary-grades');
                if (!tbody) return;
                tbody.innerHTML = salaryGrades.length ? salaryGrades.sort((a, b) => (a.level || 0) - (b.level || 0)).map((g, i) => `
        <tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(g.position || g.name || '-')}</td>
            <td>${escapeHtml(g.shift || 'Ca ng√†y')}</td>
            <td>${g.revenueFrom || 0}</td>
            <td>${g.revenueTo || 'Kh√¥ng gi·ªõi h·∫°n'}</td>
            <td>B·∫≠c ${g.level || 1}</td>
            <td style="font-weight:700;color:var(--primary);">${formatMoney(g.salary || 0)}</td>
            <td><span class="badge ${g.status === 'ƒêang √°p d·ª•ng' ? 'badge-success' : 'badge-danger'}">${escapeHtml(g.status || 'ƒêang √°p d·ª•ng')}</span></td>
            <td class="actions">
                <button class="edit" onclick="editGrade('${g.id}')"><i class="fas fa-edit"></i></button>
                <button class="delete" onclick="deleteGrade('${g.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('') : '<tr><td colspan="9" class="empty-state">Ch∆∞a c√≥ b·∫≠c l∆∞∆°ng</td></tr>';
            } catch (e) {
                console.error('Error in renderSalaryGrades:', e);
            }
        }

        function showSalaryTab(tab) {
            document.getElementById('grades-tab').style.display = tab === 'grades' ? 'block' : 'none';
            document.getElementById('employee-salary-tab').style.display = tab === 'employee-salary' ? 'block' : 'none';
            document.getElementById('promotions-tab').style.display = tab === 'promotions' ? 'block' : 'none';
            document.querySelectorAll('#salary .tabs .tab').forEach((t, i) => {
                const tabs = ['grades', 'employee-salary', 'promotions'];
                t.classList.toggle('active', tabs[i] === tab);
            });
        }

        function editGrade(id) {
            const g = salaryGrades.find(x => x.id === id);
            if (!g) return;
            document.getElementById('grade-id').value = g.id;
            document.getElementById('grade-level').value = g.level;
            document.getElementById('grade-name').value = g.name;
            document.getElementById('grade-salary').value = g.salary;
            document.getElementById('grade-allowance').value = g.allowance || 0;
            document.getElementById('grade-desc').value = g.description || '';
            openModal('salaryModal');
        }

        async function deleteGrade(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫≠c l∆∞∆°ng n√†y?')) return;
            await fbDelete(`hr/salaryGrades/${id}`);
            showToast('ƒê√£ x√≥a b·∫≠c l∆∞∆°ng');
            loadData();
        }

        document.getElementById('salaryForm').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('grade-id').value;
            const data = {
                level: parseInt(document.getElementById('grade-level').value),
                position: document.getElementById('grade-name').value,
                name: document.getElementById('grade-name').value,
                shift: document.getElementById('grade-shift')?.value || 'Ca ng√†y',
                revenueFrom: parseInt(document.getElementById('grade-revenue-from')?.value) || 0,
                revenueTo: document.getElementById('grade-revenue-to')?.value || 'Kh√¥ng gi·ªõi h·∫°n',
                salary: parseInt(document.getElementById('grade-salary').value),
                status: document.getElementById('grade-status')?.value || 'ƒêang √°p d·ª•ng',
                description: document.getElementById('grade-desc').value
            };
            if (id) await fbUpdate(`hr/salaryGrades/${id}`, data);
            else await fbPush('hr/salaryGrades', data);
            closeModal('salaryModal');
            showToast(id ? 'ƒê√£ c·∫≠p nh·∫≠t b·∫≠c l∆∞∆°ng' : 'ƒê√£ th√™m b·∫≠c l∆∞∆°ng m·ªõi');
            loadData();
        });

        // Trainings
        function renderTrainings() {
            const statusBadge = s => s === 'Ho√†n th√†nh' ? 'badge-success' : s === 'ƒêang di·ªÖn ra' ? 'badge-warning' : 'badge-info';
            document.getElementById('training-list').innerHTML = trainings.length ? trainings.map(t => `
        <tr>
            <td>${t.name}</td>
            <td>${t.instructor}</td>
            <td>${t.startDate || '-'} - ${t.endDate || '-'}</td>
            <td>${t.students || 0}</td>
            <td><span class="badge ${statusBadge(t.status)}">${t.status}</span></td>
            <td class="actions">
                <button class="edit" onclick="editTraining('${t.id}')"><i class="fas fa-edit"></i></button>
                <button class="delete" onclick="deleteTraining('${t.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('') : '<tr><td colspan="6" class="empty-state">Ch∆∞a c√≥ kh√≥a ƒë√†o t·∫°o</td></tr>';
        }

        function showCompTab(tab) {
            document.getElementById('framework-tab').style.display = tab === 'framework' ? 'block' : 'none';
            document.getElementById('evaluation-tab').style.display = tab === 'evaluation' ? 'block' : 'none';
            document.getElementById('training-tab').style.display = tab === 'training' ? 'block' : 'none';
            document.querySelectorAll('#competency .tabs .tab').forEach((t, i) => {
                const tabs = ['framework', 'evaluation', 'training'];
                t.classList.toggle('active', tabs[i] === tab);
            });
        }

        function editTraining(id) {
            const t = trainings.find(x => x.id === id);
            if (!t) return;
            document.getElementById('training-id').value = t.id;
            document.getElementById('training-name').value = t.name;
            document.getElementById('training-instructor').value = t.instructor;
            document.getElementById('training-students').value = t.students || 0;
            document.getElementById('training-start').value = t.startDate || '';
            document.getElementById('training-end').value = t.endDate || '';
            document.getElementById('training-status').value = t.status;
            document.getElementById('training-desc').value = t.description || '';
            openModal('trainingModal');
        }

        async function deleteTraining(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√≥a ƒë√†o t·∫°o n√†y?')) return;
            await fbDelete(`hr/trainings/${id}`);
            showToast('ƒê√£ x√≥a kh√≥a ƒë√†o t·∫°o');
            loadData();
        }

        document.getElementById('trainingForm').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('training-id').value;
            const data = {
                name: document.getElementById('training-name').value,
                instructor: document.getElementById('training-instructor').value,
                students: parseInt(document.getElementById('training-students').value) || 0,
                startDate: document.getElementById('training-start').value,
                endDate: document.getElementById('training-end').value,
                status: document.getElementById('training-status').value,
                description: document.getElementById('training-desc').value
            };
            if (id) await fbUpdate(`hr/trainings/${id}`, data);
            else await fbPush('hr/trainings', data);
            closeModal('trainingModal');
            showToast(id ? 'ƒê√£ c·∫≠p nh·∫≠t kh√≥a ƒë√†o t·∫°o' : 'ƒê√£ th√™m kh√≥a ƒë√†o t·∫°o m·ªõi');
            loadData();
        });

        // Evaluations
        function renderEvaluations() {
            document.getElementById('evaluation-list').innerHTML = evaluations.length ? evaluations.map(ev => {
                const emp = employees.find(e => e.id === ev.employeeId);
                const total = ((parseInt(ev.technical) || 0) + (parseInt(ev.soft) || 0) + (parseInt(ev.attitude) || 0)) / 3;
                return `
        <tr>
            <td>${emp?.name || 'N/A'}</td>
            <td>${ev.technical}/10</td>
            <td>${ev.soft}/10</td>
            <td>${ev.attitude}/10</td>
            <td><span class="kpi-score" style="color:${total >= 7 ? 'var(--success)' : total >= 5 ? 'var(--warning)' : 'var(--danger)'}">${total.toFixed(1)}</span></td>
            <td>${ev.date || '-'}</td>
        </tr>
    `}).join('') : '<tr><td colspan="6" class="empty-state">Ch∆∞a c√≥ ƒë√°nh gi√°</td></tr>';
        }

        document.getElementById('evalForm').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('eval-id').value;
            const data = {
                employeeId: document.getElementById('eval-employee').value,
                technical: document.getElementById('eval-technical').value,
                soft: document.getElementById('eval-soft').value,
                attitude: document.getElementById('eval-attitude').value,
                date: document.getElementById('eval-date').value,
                comment: document.getElementById('eval-comment').value
            };
            if (id) await fbUpdate(`hr/evaluations/${id}`, data);
            else await fbPush('hr/evaluations', data);
            closeModal('evalModal');
            showToast('ƒê√£ l∆∞u ƒë√°nh gi√°');
            loadData();
        });

        // KPIs
        function renderKPIs(filtered = null) {
            const list = filtered || kpis;
            const statusBadge = s => s === 'Ho√†n th√†nh' ? 'badge-success' : s === 'Ch∆∞a ƒë·∫°t' ? 'badge-danger' : 'badge-warning';
            const progressColor = p => p >= 80 ? 'green' : p >= 50 ? 'orange' : 'red';
            document.getElementById('kpi-list').innerHTML = list.length ? list.map(k => {
                const emp = employees.find(e => e.id === k.employeeId);
                return `
        <tr>
            <td>${emp?.name || 'N/A'}</td>
            <td>${k.name}</td>
            <td>${k.target}</td>
            <td>${k.result || '-'}</td>
            <td><div class="progress-bar"><div class="progress-fill ${progressColor(k.progress)}" style="width:${k.progress}%"></div></div><small>${k.progress}%</small></td>
            <td><span class="badge ${statusBadge(k.status)}">${k.status}</span></td>
            <td class="actions">
                <button class="edit" onclick="editKPI('${k.id}')"><i class="fas fa-edit"></i></button>
                <button class="delete" onclick="deleteKPI('${k.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `}).join('') : '<tr><td colspan="7" class="empty-state">Ch∆∞a c√≥ KPI</td></tr>';
        }

        function filterKPI() {
            const search = document.getElementById('search-kpi').value.toLowerCase();
            const status = document.getElementById('filter-kpi-status').value;
            const filtered = kpis.filter(k => {
                const emp = employees.find(e => e.id === k.employeeId);
                return (k.name.toLowerCase().includes(search) || emp?.name?.toLowerCase().includes(search)) && (!status || k.status === status);
            });
            renderKPIs(filtered);
        }

        function editKPI(id) {
            const k = kpis.find(x => x.id === id);
            if (!k) return;
            document.getElementById('kpi-id').value = k.id;
            document.getElementById('kpi-employee').value = k.employeeId;
            document.getElementById('kpi-name').value = k.name;
            document.getElementById('kpi-target').value = k.target;
            document.getElementById('kpi-result').value = k.result || '';
            document.getElementById('kpi-progress').value = k.progress || 0;
            document.getElementById('kpi-status').value = k.status;
            document.getElementById('kpi-start').value = k.startDate || '';
            document.getElementById('kpi-end').value = k.endDate || '';
            document.getElementById('kpi-note').value = k.note || '';
            openModal('kpiModal');
        }

        async function deleteKPI(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a KPI n√†y?')) return;
            await fbDelete(`hr/kpis/${id}`);
            showToast('ƒê√£ x√≥a KPI');
            loadData();
        }

        document.getElementById('kpiForm').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('kpi-id').value;
            const data = {
                employeeId: document.getElementById('kpi-employee').value,
                name: document.getElementById('kpi-name').value,
                target: document.getElementById('kpi-target').value,
                result: document.getElementById('kpi-result').value,
                progress: parseInt(document.getElementById('kpi-progress').value) || 0,
                status: document.getElementById('kpi-status').value,
                startDate: document.getElementById('kpi-start').value,
                endDate: document.getElementById('kpi-end').value,
                note: document.getElementById('kpi-note').value
            };
            if (id) await fbUpdate(`hr/kpis/${id}`, data);
            else await fbPush('hr/kpis', data);
            closeModal('kpiModal');
            showToast(id ? 'ƒê√£ c·∫≠p nh·∫≠t KPI' : 'ƒê√£ giao KPI m·ªõi');
            loadData();
        });

        // Tasks
        function renderTasks(filtered = null) {
            const list = filtered || tasks;
            const statusBadge = s => s === 'ƒê√£ xong' ? 'badge-success' : s === 'Qu√° h·∫°n' ? 'badge-danger' : 'badge-warning';
            const priorityBadge = p => p === 'Cao' ? 'priority-cao' : p === 'Trung b√¨nh' ? 'priority-tb' : 'priority-thap';
            document.getElementById('task-list').innerHTML = list.length ? list.map((t, i) => {
                const assignee = nhanSuData.find(e => e.id === t.assigneeId);
                const assigner = nhanSuData.find(e => e.id === t.assignerId);
                return `
        <tr>
            <td>${i + 1}</td>
            <td><code style="background:#f0f0f0;padding:2px 6px;border-radius:4px;">${escapeHtml(t.code || `T-${i + 1}`)}</code></td>
            <td>${escapeHtml(t.name || '-')}</td>
            <td>${escapeHtml(t.department || '-')}</td>
            <td>${escapeHtml(assigner?.ho_va_ten || assigner?.name || t.assigner || '-')}</td>
            <td>${escapeHtml(assignee?.ho_va_ten || assignee?.name || '-')}</td>
            <td><span class="status-badge ${priorityBadge(t.priority)}">${escapeHtml(t.priority || 'Trung b√¨nh')}</span></td>
            <td>${t.startDate || '-'}</td>
            <td>${t.deadline || '-'}</td>
            <td><span class="badge ${statusBadge(t.status)}">${escapeHtml(t.status || 'ƒêang l√†m')}</span></td>
            <td>${t.resultLink ? `<a href="${escapeHtml(t.resultLink)}" target="_blank" class="btn btn-info btn-sm" style="font-size:10px;padding:4px 8px;"><i class="fas fa-link"></i></a>` : '-'}</td>
            <td class="actions">
                <button class="edit" onclick="editTask('${t.id}')"><i class="fas fa-edit"></i></button>
                <button class="delete" onclick="deleteTask('${t.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `}).join('') : '<tr><td colspan="12" class="empty-state">Ch∆∞a c√≥ c√¥ng vi·ªác</td></tr>';
        }

        function filterTasks() {
            const search = document.getElementById('search-task').value.toLowerCase();
            const status = document.getElementById('filter-task-status').value;
            const filtered = tasks.filter(t => t.name.toLowerCase().includes(search) && (!status || t.status === status));
            renderTasks(filtered);
        }

        function editTask(id) {
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            document.getElementById('task-id').value = t.id;
            document.getElementById('task-name').value = t.name;
            document.getElementById('task-assignee').value = t.assigneeId;
            document.getElementById('task-priority').value = t.priority;
            document.getElementById('task-deadline').value = t.deadline || '';
            document.getElementById('task-progress').value = t.progress || 0;
            document.getElementById('task-status').value = t.status;
            document.getElementById('task-desc').value = t.description || '';
            openModal('taskModal');
        }

        async function deleteTask(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¥ng vi·ªác n√†y?')) return;
            await fbDelete(`hr/tasks/${id}`);
            showToast('ƒê√£ x√≥a c√¥ng vi·ªác');
            loadData();
        }

        document.getElementById('taskForm').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('task-id').value;
            const data = {
                name: document.getElementById('task-name').value,
                assigneeId: document.getElementById('task-assignee').value,
                priority: document.getElementById('task-priority').value,
                deadline: document.getElementById('task-deadline').value,
                progress: parseInt(document.getElementById('task-progress').value) || 0,
                status: document.getElementById('task-status').value,
                description: document.getElementById('task-desc').value
            };
            if (id) await fbUpdate(`hr/tasks/${id}`, data);
            else await fbPush('hr/tasks', data);
            closeModal('taskModal');
            showToast(id ? 'ƒê√£ c·∫≠p nh·∫≠t c√¥ng vi·ªác' : 'ƒê√£ giao vi·ªác m·ªõi');
            loadData();
        });

        // Attendance
        function renderAttendance() {
            document.getElementById('attendance-list').innerHTML = attendances.length ? attendances.map(a => {
                const emp = employees.find(e => e.id === a.employeeId);
                return `
        <tr>
            <td>${emp?.name || 'N/A'}</td>
            <td>${a.workdays}</td>
            <td>${a.late || 0}</td>
            <td>${a.early || 0}</td>
            <td>${a.leave || 0}</td>
            <td>${a.absent || 0}</td>
            <td class="actions">
                <button class="edit" onclick="editAttendance('${a.id}')"><i class="fas fa-edit"></i></button>
                <button class="delete" onclick="deleteAttendance('${a.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `}).join('') : '<tr><td colspan="7" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng</td></tr>';
        }

        function showAttTab(tab) {
            document.getElementById('timekeeping-tab').style.display = tab === 'timekeeping' ? 'block' : 'none';
            document.getElementById('payroll-tab').style.display = tab === 'payroll' ? 'block' : 'none';
            document.getElementById('bhxh-tab').style.display = tab === 'bhxh' ? 'block' : 'none';
            document.getElementById('tax-tab').style.display = tab === 'tax' ? 'block' : 'none';
            document.getElementById('payslip-tab').style.display = tab === 'payslip' ? 'block' : 'none';
            document.querySelectorAll('#attendance .tabs .tab').forEach((t, i) => {
                const tabs = ['timekeeping', 'payroll', 'bhxh', 'tax', 'payslip'];
                t.classList.toggle('active', tabs[i] === tab);
            });
            if (tab === 'bhxh') loadBHXH();
            if (tab === 'tax') loadTax();
            if (tab === 'payslip') populatePayslipEmployees();
        }

        function editAttendance(id) {
            const a = attendances.find(x => x.id === id);
            if (!a) return;
            document.getElementById('att-id').value = a.id;
            document.getElementById('att-employee').value = a.employeeId;
            document.getElementById('att-m').value = a.month;
            document.getElementById('att-y').value = a.year;
            document.getElementById('att-workdays').value = a.workdays;
            document.getElementById('att-late').value = a.late || 0;
            document.getElementById('att-early').value = a.early || 0;
            document.getElementById('att-leave').value = a.leave || 0;
            document.getElementById('att-absent').value = a.absent || 0;
            openModal('attendanceModal');
        }

        async function deleteAttendance(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ªØ li·ªáu ch·∫•m c√¥ng n√†y?')) return;
            await fbDelete(`hr/attendances/${id}`);
            showToast('ƒê√£ x√≥a d·ªØ li·ªáu ch·∫•m c√¥ng');
            loadData();
        }

        document.getElementById('attendanceForm').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('att-id').value;
            const data = {
                employeeId: document.getElementById('att-employee').value,
                month: parseInt(document.getElementById('att-m').value),
                year: parseInt(document.getElementById('att-y').value),
                workdays: parseInt(document.getElementById('att-workdays').value),
                late: parseInt(document.getElementById('att-late').value) || 0,
                early: parseInt(document.getElementById('att-early').value) || 0,
                leave: parseInt(document.getElementById('att-leave').value) || 0,
                absent: parseInt(document.getElementById('att-absent').value) || 0
            };
            if (id) await fbUpdate(`hr/attendances/${id}`, data);
            else await fbPush('hr/attendances', data);
            closeModal('attendanceModal');
            showToast('ƒê√£ l∆∞u ch·∫•m c√¥ng');
            loadData();
        });

        function loadAttendance() {
            const month = document.getElementById('att-month').value;
            const year = document.getElementById('att-year').value;
            const filtered = attendances.filter(a => a.month == month && a.year == year);
            document.getElementById('attendance-list').innerHTML = filtered.length ? filtered.map(a => {
                const emp = employees.find(e => e.id === a.employeeId);
                return `
        <tr>
            <td>${emp?.name || 'N/A'}</td>
            <td>${a.workdays}</td>
            <td>${a.late || 0}</td>
            <td>${a.early || 0}</td>
            <td>${a.leave || 0}</td>
            <td>${a.absent || 0}</td>
            <td class="actions">
                <button class="edit" onclick="editAttendance('${a.id}')"><i class="fas fa-edit"></i></button>
                <button class="delete" onclick="deleteAttendance('${a.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `}).join('') : '<tr><td colspan="7" class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        }

        function calculatePayroll() {
            const month = document.getElementById('att-month').value;
            const year = document.getElementById('att-year').value;
            const monthAtt = attendances.filter(a => a.month == month && a.year == year);

            let html = '';
            employees.forEach(emp => {
                const att = monthAtt.find(a => a.employeeId === emp.id);
                const grade = salaryGrades[0] || { salary: 10000000, allowance: 1000000 };
                const baseSalary = grade.salary;
                const allowance = grade.allowance || 0;
                const workdays = att?.workdays || 22;
                const actualSalary = (baseSalary / 22) * workdays;
                const bhxh = actualSalary * 0.105; // 10.5%
                const taxableIncome = actualSalary + allowance - bhxh - 11000000; // Gi·∫£m tr·ª´ b·∫£n th√¢n
                const tax = taxableIncome > 0 ? taxableIncome * 0.05 : 0; // Thu·∫ø 5% b·∫≠c 1
                const netSalary = actualSalary + allowance - bhxh - tax;

                html += `
        <tr>
            <td>${emp.name}</td>
            <td>${formatMoney(baseSalary)}</td>
            <td>${formatMoney(allowance)}</td>
            <td>${formatMoney(bhxh)}</td>
            <td>${formatMoney(tax)}</td>
            <td><strong style="color:var(--primary)">${formatMoney(netSalary)}</strong></td>
        </tr>
        `;
            });

            document.getElementById('payroll-list').innerHTML = html || '<tr><td colspan="6" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            showToast('ƒê√£ t√≠nh l∆∞∆°ng th√°ng ' + month + '/' + year);
        }

        function populateEmployeeSelects() {
            try {
                if (!Array.isArray(nhanSuData)) return;
                const options = nhanSuData.map(e => {
                    const name = e.ho_va_ten || e.name || e.T√™n || 'N/A';
                    const code = e.id || '';
                    return `<option value="${e.id || ''}">${escapeHtml(name)}${code ? ' - ' + code.substring(0, 8) : ''}</option>`;
                }).join('');
                const defaultOption = '<option value="">Ch·ªçn nh√¢n vi√™n</option>';

                const evalEmp = document.getElementById('eval-employee');
                const kpiEmp = document.getElementById('kpi-employee');
                const taskAssignee = document.getElementById('task-assignee');
                const attEmp = document.getElementById('att-employee');

                if (evalEmp) evalEmp.innerHTML = defaultOption + options;
                if (kpiEmp) kpiEmp.innerHTML = defaultOption + options;
                if (taskAssignee) taskAssignee.innerHTML = defaultOption + options;
                if (attEmp) attEmp.innerHTML = defaultOption + options;
            } catch (e) {
                console.error('Error in populateEmployeeSelects:', e);
            }
        }

        // ========== NEW FORM EVENT LISTENERS ==========
        document.getElementById('dinhBienForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('dinh-bien-id').value;
            const data = {
                department: document.getElementById('dinh-bien-dept').value,
                position: document.getElementById('dinh-bien-position').value,
                current: parseInt(document.getElementById('dinh-bien-current').value) || 0,
                target: parseInt(document.getElementById('dinh-bien-target').value) || 0,
                note: document.getElementById('dinh-bien-note').value
            };
            if (id) await fbUpdate(`hr/recruitment/dinhBiens/${id}`, data);
            else await fbPush('hr/recruitment/dinhBiens', data);
            closeModal('dinhBienModal');
            showToast('ƒê√£ l∆∞u ƒë·ªãnh bi√™n');
            loadRecruitmentData();
        });

        document.getElementById('cvForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('cv-id').value;
            const data = {
                name: document.getElementById('cv-name').value,
                phone: document.getElementById('cv-phone').value,
                email: document.getElementById('cv-email').value,
                source: document.getElementById('cv-source').value,
                position: document.getElementById('cv-position').value,
                department: document.getElementById('cv-dept').value,
                status: document.getElementById('cv-status').value,
                date: document.getElementById('cv-date').value || new Date().toISOString().split('T')[0]
            };
            if (id) await fbUpdate(`hr/recruitment/cvList/${id}`, data);
            else await fbPush('hr/recruitment/cvList', data);
            closeModal('cvModal');
            showToast('ƒê√£ l∆∞u CV ·ª©ng vi√™n');
            loadRecruitmentData();
        });

        document.getElementById('competencyFrameworkForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('competency-id').value;
            const data = {
                department: document.getElementById('competency-dept').value,
                position: document.getElementById('competency-position').value,
                group: document.getElementById('competency-group').value,
                name: document.getElementById('competency-name').value,
                level: parseInt(document.getElementById('competency-level').value),
                status: document.getElementById('competency-status').value,
                note: document.getElementById('competency-note').value
            };
            if (id) await fbUpdate(`hr/competencyFramework/${id}`, data);
            else await fbPush('hr/competencyFramework', data);
            closeModal('competencyFrameworkModal');
            showToast('ƒê√£ l∆∞u khung nƒÉng l·ª±c');
            loadCompetencyFramework();
        });

        async function loadCompetencyFramework() {
            try {
                const data = await fbGet('hr/competencyFramework');
                competencyFramework = data ? Object.entries(data).map(([k, v]) => ({ ...v, id: k })) : [];
                if (document.getElementById('competency-framework-list')) {
                    renderCompetencyFramework();
                }
            } catch (e) {
                console.warn('Competency framework data not found:', e);
                competencyFramework = [];
            }
        }

        function renderCompetencyFramework() {
            const tbody = document.getElementById('competency-framework-list');
            if (!tbody) return;
            tbody.innerHTML = competencyFramework.length ? competencyFramework.map((c, i) => `<tr>
        <td>${i + 1}</td>
        <td>${escapeHtml(c.group || '-')}</td>
        <td>${escapeHtml(c.name || '-')}</td>
        <td>${c.level === 1 ? '1' : '-'}</td>
        <td>${c.level === 2 ? '2' : '-'}</td>
        <td>${c.level === 3 ? '3' : '-'}</td>
        <td>${c.level === 4 ? '4' : '-'}</td>
        <td>${c.level === 5 ? '5' : '-'}</td>
        <td><span class="badge ${c.status === '√Åp d·ª•ng' ? 'badge-success' : 'badge-danger'}">${escapeHtml(c.status || '-')}</span></td>
        <td class="actions"><button class="edit" onclick="editCompetency('${c.id}')"><i class="fas fa-edit"></i></button><button class="delete" onclick="deleteCompetency('${c.id}')"><i class="fas fa-trash"></i></button></td>
    </tr>`).join('') : '<tr><td colspan="10" class="empty-state">Ch∆∞a c√≥ khung nƒÉng l·ª±c</td></tr>';
        }

        async function deleteCompetency(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nƒÉng l·ª±c n√†y?')) return;
            await fbDelete(`hr/competencyFramework/${id}`);
            showToast('ƒê√£ x√≥a nƒÉng l·ª±c');
            loadCompetencyFramework();
        }

        function editCompetency(id) {
            const c = competencyFramework.find(x => x.id === id);
            if (!c) return;
            document.getElementById('competency-id').value = c.id;
            document.getElementById('competency-dept').value = c.department || '';
            document.getElementById('competency-position').value = c.position || '';
            document.getElementById('competency-group').value = c.group || 'Chuy√™n m√¥n';
            document.getElementById('competency-name').value = c.name || '';
            document.getElementById('competency-level').value = c.level || 1;
            document.getElementById('competency-status').value = c.status || '√Åp d·ª•ng';
            document.getElementById('competency-note').value = c.note || '';
            openModal('competencyFrameworkModal');
        }

        document.getElementById('kpiCatalogForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('kpi-catalog-id').value;
            const data = {
                code: document.getElementById('kpi-code').value,
                name: document.getElementById('kpi-catalog-name').value,
                unit: document.getElementById('kpi-unit').value,
                targetGroup: document.getElementById('kpi-target-group').value,
                weight: parseInt(document.getElementById('kpi-weight').value) || 50,
                applyMonth: document.getElementById('kpi-apply-month').value,
                status: document.getElementById('kpi-catalog-status').value
            };
            if (id) await fbUpdate(`hr/kpiCatalog/${id}`, data);
            else await fbPush('hr/kpiCatalog', data);
            closeModal('kpiCatalogModal');
            showToast('ƒê√£ l∆∞u danh m·ª•c KPI');
            loadKPICatalog();
        });

        document.getElementById('bhxhForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('bhxh-id').value;
            const data = {
                employeeId: document.getElementById('bhxh-employee').value,
                bhxhNumber: document.getElementById('bhxh-number').value,
                joinDate: document.getElementById('bhxh-join-date').value,
                salary: parseInt(document.getElementById('bhxh-salary').value) || 0,
                status: document.getElementById('bhxh-status').value,
                rateEmployee: parseFloat(document.getElementById('bhxh-rate-employee').value) || 10.5,
                rateCompany: parseFloat(document.getElementById('bhxh-rate-company').value) || 21.5
            };
            if (id) await fbUpdate(`hr/bhxh/${id}`, data);
            else await fbPush('hr/bhxh', data);
            closeModal('bhxhModal');
            showToast('ƒê√£ l∆∞u th√¥ng tin BHXH');
            loadBHXH();
        });

        document.getElementById('taxForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('tax-id').value;
            const data = {
                employeeId: document.getElementById('tax-employee').value,
                taxCode: document.getElementById('tax-code').value,
                taxType: document.getElementById('tax-type').value,
                personalDeduction: parseInt(document.getElementById('tax-personal-deduction').value) || 11000000,
                period: document.getElementById('tax-period').value
            };
            if (id) await fbUpdate(`hr/tax/info/${id}`, data);
            else await fbPush('hr/tax/info', data);
            closeModal('taxModal');
            showToast('ƒê√£ l∆∞u th√¥ng tin thu·∫ø');
            loadTax();
        });

        document.getElementById('dependentForm')?.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('dependent-id').value;
            const data = {
                employeeId: document.getElementById('dependent-employee').value,
                name: document.getElementById('dependent-name').value,
                relation: document.getElementById('dependent-relation').value,
                dob: document.getElementById('dependent-dob').value,
                cccd: document.getElementById('dependent-cccd').value,
                fromDate: document.getElementById('dependent-from').value,
                toDate: document.getElementById('dependent-to').value,
                status: document.getElementById('dependent-status').value
            };
            if (id) await fbUpdate(`hr/tax/dependents/${id}`, data);
            else await fbPush('hr/tax/dependents', data);
            closeModal('dependentModal');
            showToast('ƒê√£ l∆∞u ng∆∞·ªùi ph·ª• thu·ªôc');
            loadTax();
        });

        async function loadKPICatalog() {
            try {
                const data = await fbGet('hr/kpiCatalog');
                kpiCatalog = data ? Object.entries(data).map(([k, v]) => ({ ...v, id: k })) : [];
                if (document.getElementById('kpi-catalog-list')) {
                    renderKPICatalog();
                }
            } catch (e) {
                console.warn('KPI catalog data not found:', e);
                kpiCatalog = [];
            }
        }

        function renderKPICatalog() {
            const tbody = document.getElementById('kpi-catalog-list');
            if (!tbody) return;
            tbody.innerHTML = kpiCatalog.length ? kpiCatalog.map((k, i) => `<tr>
        <td>${i + 1}</td>
        <td><code style="background:#f0f0f0;padding:2px 6px;border-radius:4px;">${escapeHtml(k.code || '-')}</code></td>
        <td>${escapeHtml(k.name || '-')}</td>
        <td>${escapeHtml(k.unit || '-')}</td>
        <td>${escapeHtml(k.targetGroup || '-')}</td>
        <td>${k.weight || 0}%</td>
        <td>${k.applyMonth || '-'}</td>
        <td><span class="badge ${k.status === 'ƒêang √°p d·ª•ng' ? 'badge-success' : 'badge-danger'}">${escapeHtml(k.status || '-')}</span></td>
        <td class="actions"><button class="edit" onclick="editKPICatalog('${k.id}')"><i class="fas fa-edit"></i></button><button class="delete" onclick="deleteKPICatalog('${k.id}')"><i class="fas fa-trash"></i></button></td>
    </tr>`).join('') : '<tr><td colspan="9" class="empty-state">Ch∆∞a c√≥ danh m·ª•c KPI</td></tr>';
        }

        async function deleteKPICatalog(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c KPI n√†y?')) return;
            await fbDelete(`hr/kpiCatalog/${id}`);
            showToast('ƒê√£ x√≥a danh m·ª•c KPI');
            loadKPICatalog();
        }

        async function deleteDependent(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi ph·ª• thu·ªôc n√†y?')) return;
            await fbDelete(`hr/tax/dependents/${id}`);
            showToast('ƒê√£ x√≥a ng∆∞·ªùi ph·ª• thu·ªôc');
            loadTax();
        }

        async function deleteDinhBien(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªãnh bi√™n n√†y?')) return;
            await fbDelete(`hr/recruitment/dinhBiens/${id}`);
            showToast('ƒê√£ x√≥a ƒë·ªãnh bi√™n');
            loadRecruitmentData();
        }

        async function deleteCV(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a CV n√†y?')) return;
            await fbDelete(`hr/recruitment/cvList/${id}`);
            showToast('ƒê√£ x√≥a CV');
            loadRecruitmentData();
        }

        // Initialize - wait for DOM to be ready
        function initializeApp() {
            try {
                // Load data asynchronously
                Promise.all([
                    loadData().catch(e => { console.error('Error in loadData:', e); return null; }),
                    loadKPICatalog().catch(e => { console.warn('Error in loadKPICatalog:', e); return null; }),
                    loadCompetencyFramework().catch(e => { console.warn('Error in loadCompetencyFramework:', e); return null; })
                ]).then(() => {
                    // Ensure first tab is shown when employees page is active
                    setTimeout(() => {
                        const employeesPage = document.getElementById('employees');
                        if (employeesPage && employeesPage.classList.contains('active')) {
                            showEmployeeTab('list');
                        }
                        // Always render dashboard to ensure stats are up to date
                        renderDashboard();
                    }, 300);
                });
            } catch (e) {
                console.error('Error initializing app:', e);
                showToast('L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng: ' + (e.message || 'Unknown error'), true);
                // Still try to render dashboard
                setTimeout(() => {
                    renderDashboard();
                }, 300);
            }
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM is already ready
            initializeApp();
        }
    </script>
</body>

</html>